<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Working with macro signatures - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo" />
                </h1>
                <a href="Kentico_11_Documentation_Home.html" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=68882656"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico_11_Documentation_Home.html">Kentico 11 Documentation</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="Macro_expressions.html">Macro expressions</a></li>
                                                                                     <li><a href="Troubleshooting_macros.html">Troubleshooting macros</a></li>
                                                            </ul>
</div>            <h1 id="src-68882656"> <span>Working with macro signatures</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
        $page.content
<p   
>Whenever a user saves a <a   href="Macro_expressions.html">macro expression</a>, the system automatically adds a security signature. Signatures prevent macros from accessing or displaying data for which the author is not authorized.</p>
<p   
>Every macro signature contains an identifier of the macro&#39;s author and a hash of the given expression. To increase the level of security, the hash function used when creating macro signatures appends a salt to the input (a sequence of additional characters). The salt value depends on the <a   href="#src-68882656_Workingwithmacrosignatures-Configuringthehashsaltformacrosignatures">configuration</a> of the application&#39;s environment, so the signatures are in most cases not valid when deploying macros to other instances of Kentico.</p>
<p   
>You can recognize signed macro expressions by the <strong class=" ">#</strong> character, which the system automatically inserts before the closing <strong class=" ">%}</strong> parentheses when saving the text containing the macro.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">{% CurrentUser.Children[</code><code class="string">"cms_category"</code><code class="plain">][0].CategoryName #%}</code></div>
</div>
    </div>
<p   
>If the execution of the macro requires any <a   href="Configuring_permissions.html">permissions</a>, the system resolves the macro only if the <strong class=" ">user specified by the signature</strong> has the appropriate permissions.</p>
<p   
>Permissions are only checked when resolving macro expressions that:</p>
<ul class=" "><li class=" "><p   
>access objects that are members of another object, for example: <i class=" ">{% CurrentDocument.DocumentPageTemplate %}</i></p>
</li><li class=" "><p   
>access collections of objects, for example: <i class=" ">{% CurrentUser.Children[&quot;cms_category&quot;][0].CategoryName %}</i></p>
</li></ul><p   
>The system carries out a security check for each access to any collection, not just for the final macro result.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Unsuccessful security checks prevent the system from resolving macros. If you encounter such problems, you can view the <a   href="Working_with_the_system_event_log.html">event log</a> or the <a   href="Debugging_macros.html">macro debug log</a>, which provide information about performed security checks and their results.</p>
        </div>
    </div>
    <div  class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Tip</strong>: You can confirm whether your macros have valid signatures by searching for expressions in <strong class=" ">System -&gt; Macros -&gt; Report</strong>.</p>
<p   
>See: <a   href="Searching_for_macros.html">Searching for macros</a></p>
        </div>
    </div>
    <div  class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-68882656_Workingwithmacrosignatures-Assigningmacrosignatureidentities">Assigning macro signature identities</a></p>
</li><li class=" "><p   
><a   href="#src-68882656_Workingwithmacrosignatures-Disablingthesecuritysignatureforspecificmacros">Disabling the security signature for specific macros</a></p>
</li><li class=" "><p   
><a   href="#src-68882656_Workingwithmacrosignatures-Configuringthehashsaltformacrosignatures">Configuring the hash salt for macro signatures</a></p>
</li><li class=" "><p   
><a   href="#src-68882656_Workingwithmacrosignatures-Re-signingmacros">Re-signing macros</a></p>
</li></ul><p   
></p>
        </div>
    </div>
    <div  class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p   
><a   href="Macros_and_security.html">Macros and security</a></p>
</li></ul>        </div>
    </div>
    <h3 id="src-68882656_Workingwithmacrosignatures-Assigningmacrosignatureidentities" class="heading "><span>Assigning macro signature identities</span></h3>
<p   
>Every macro signature contains an identifier of the user who entered and saved the expression. By default, the identifier is the user name.</p>
<p   
>Alternatively, administrators can assign special macro signature identities to users, which then replace the user name in the signatures of all macro expressions created by the given users. The same macro identity can be shared by any number of users. Each identity has an <i class=" ">effective user</i>, which the system checks instead of the original user when evaluating permissions while resolving macro expressions.</p>
<p   
>The following examples show how a signed macro expression is stored in the database, including the full signature (both types):</p>
<ul class=" "><li class=" "><p   
>User name:<i class=" "> {%CurrentSite.SiteName|<strong class=" ">(user)administrator</strong>|(hash)9056b7b76629a47a660c40cc2e5b0d92a13d0f9bce178847ca412c3a585552a1%}</i></p>
</li><li class=" "><p   
>Macro identity:<i class=" "> {%CurrentSite.SiteName|<strong class=" ">(identity)GlobalAdministrator</strong>|(hash)e3402fe14374ab15d119dddbb6c831ce3d2ef55bd8e70ce8eb80994f4e6ad18b%}</i></p>
</li></ul><p   
>Signature identities can be useful in environments where you transfer data containing macro expressions between multiple Kentico instances, for example when using <a   href="Content_staging.html">staging</a> or <a   href="Setting_up_continuous_integration.html">continuous integration</a>. With the default user name signatures, you may encounter problems with invalid macros if you do not have exactly the same set of users across all instances &ndash; macro signatures are not valid if the signed user does not exist on the given instance. By assigning an identity with the same name to users across different instances, you can avoid the need to synchronize all users across all instances or manually re-sign macros after transferring data.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Security information</strong></p>
<ul class=" "><li class=" "><p   
>Only users with the <i class=" ">Global administrator</i> <a   href="User_management.html">privilege level</a> can manage macro signature identities and assign them to users.</p>
</li><li class=" "><p   
>Identities are not suitable for highly secure environments that require signatures to identify the exact author of each macro. If multiple users share the same macro identity, signatures cannot be used to determine which of the users is the author.</p>
</li></ul>        </div>
    </div>
<p   
>To create a macro signature identity:</p>
<ol class=" "><li class=" "><p   
>Open the <strong class=" ">System</strong> application.</p>
</li><li class=" "><p   
>Select the <strong class=" ">Macros -&gt; Identities</strong> tab.</p>
</li><li class=" "><p   
>Click <strong class=" ">New macro identity</strong>.</p>
</li><li class=" "><p  class="auto-cursor-target" 
>Enter an <strong class=" ">Identity name</strong>.</p>
</li><li class=" "><p  class="auto-cursor-target" 
>Assign an <strong class=" ">Effective user</strong>.</p>
</li><li class=" "><p  class="auto-cursor-target" 
>Click <strong class=" ">Save</strong>.</p>
</li></ol>    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Notes</strong></p>
<ul class=" "><li class=" "><p   
>The <i class=" ">Identity name</i> value is added into macro signatures instead of the user name of the author. You <i class=" "><strong class=" ">cannot change</strong></i> the name of a macro identity after you save it (the change would make macro expressions signed by the given identity invalid).</p>
</li><li class=" "><p   
>If you do not assign a valid <i class=" ">Effective user</i>, the system evaluates macros signed by the identity with the restricted permissions of a public user.</p>
</li></ul>        </div>
    </div>
<p   
>To assign a macro identity to a user:</p>
<ol class=" "><li class=" "><p   
>Edit the required user in the <strong class=" ">Users</strong> application.</p>
</li><li class=" "><p   
>On the <strong class=" ">General</strong> tab, select a <strong class=" ">Macro signature identity</strong>.</p>
</li><li class=" "><p   
>Click <strong class=" ">Save</strong>.</p>
</li></ol><p   
>All macros entered by the user are now signed with the selected identity instead of the user&#39;s name. This does NOT retroactively change the user&#39;s signatures for already existing macro expressions. You cannot assign more than one macro identity to each user, but the same identity can be shared by any number of users.</p>
    <h3 id="src-68882656_Workingwithmacrosignatures-Disablingthesecuritysignatureforspecificmacros" class="heading "><span>Disabling the security signature for specific macros</span></h3>
<p   
>You can stop the system from adding macro signatures by manually adding the <strong class=" ">@</strong> character before the closing %} sequence of a macro:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">{% CurrentPageInfo.DocumentName @%}</code></div>
</div>
    </div>
<p   
>Unsigned macros are always evaluated with the permissions of a public user. As a result, expressions that require any permissions will not resolve correctly when unsigned.</p>
<p   
>The advantage of unsigned macros is that they do not store an identifier of the author or a security hash. This allows you to:</p>
<ul class=" "><li class=" "><p   
>Add macros into fields that have a limited character count (unsigned macro expressions have the same internal length as the visible number of characters)</p>
</li><li class=" "><p   
>Create macros that are easier to deploy to other Kentico instances (they do not rely on a specific user or identity, and the environment&#39;s <a   href="#src-68882656_Workingwithmacrosignatures-Configuringthehashsaltformacrosignatures">hash salt</a> value)</p>
</li></ul>    <h3 id="src-68882656_Workingwithmacrosignatures-Configuringthehashsaltformacrosignatures" class="heading "><span>Configuring the hash salt for macro signatures</span></h3>
<p   
>The system appends a <a  class="external-link" href="http://en.wikipedia.org/wiki/Salt_%28cryptography%29">salt</a> to the input of the hash function that creates macro signatures.</p>
<p   
>By default, new instances of Kentico use a randomly generated <a  class="external-link" href="http://en.wikipedia.org/wiki/GUID">GUID</a> as the hash salt. The installer sets the custom salt value through the <strong class=" ">CMSHashStringSalt</strong> key in the <i class=" ">appSettings</i> section of the web.config file. Instances without this web.config key use the application&#39;s main database connection string as the salt (the exact <strong class=" ">CMSConnectionString</strong> value in the web.config file). We strongly recommend using a custom salt (CMSHashStringSalt).</p>
<p   
>A custom salt provides the following benefits:</p>
<ul class=" "><li class=" "><p   
>Stability (you do not need to re-sign macros if your connection string changes)</p>
</li><li class=" "><p   
>You can use the same salt for other instances of Kentico, which makes deployment easier and allows <a   href="Content_staging.html">content staging</a> of macros</p>
</li></ul><p   
>The best option is to set the hash salt value before you start creating content for your website.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Warning</strong></p>
<p   
>Changing the salt causes all current hash values to become invalid, including the signatures of macros. Having invalid macros throughout the system may lead to problems on your website, and also <i class=" "><strong class=" ">prevents the Kentico administration interface from working correctly</strong></i>. You need to <a   href="#src-68882656_Workingwithmacrosignatures-Re-signingmacros">re-sign macros</a> immediately after changing the hash salt value.</p>
<p   
>In addition to macro signatures, the system uses the <strong class=" ">CMSHashStringSalt</strong> value for other hash functions. Changing the hash salt on a website that already has defined content may break dialog links and images on your website. If you encounter such problems, you need to re-save the given content (the system then creates the hashes using the new salt).</p>
        </div>
    </div>
<p   
>To change the salt value for your application, edit the value of the <strong class=" ">CMSHashStringSalt</strong> key in your web.config file. You can use any string as the value, but the salt should be random and at least 16 characters long. For example:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;add key=</code><code class="string">"CMSHashStringSalt"</code><code class="plain"> value=</code><code class="string">"e68b9ad6-a461-4707-8e3e-ece73f03dd02"</code><code class="plain"> /&gt;</code></div>
</div>
    </div>
    <h3 id="src-68882656_Workingwithmacrosignatures-Re-signingmacros" class="heading "><span>Re-signing macros</span></h3>
<p   
>If the hash salt value used by your application changes, the security signatures of existing macro expressions become invalid. For example, you may encounter problems with unresolved macros:</p>
<ul class=" "><li class=" "><p   
>After setting a new custom salt via the <strong class=" ">CMSHashStringSalt</strong> web.config key.</p>
</li><li class=" "><p   
>When using <a   href="Content_staging.html">Content staging</a> to transfer data containing macros to an instance of Kentico with a different hash salt.</p>
</li><li class=" "><p   
>If your application does not have a custom hash salt, and the connection string has changed (for example when moving to a different server or after setting a new database password).</p>
</li></ul><p   
>To re-sign individual macros, find the expression in the user interface and save the value (you can use the <a   href="Searching_for_macros.html">macro report tool</a> to find the location). The system creates a new signature for the macro based on the application&#39;s current environment.</p>
<p   
>You can also repair invalid macro signatures by re-signing all macros in the system:</p>
<ol class=" "><li class=" "><p   
>Go to <strong class=" ">System -&gt; Macros -&gt; Signatures</strong>.</p>
</li><li class=" "><p   
>Fill in the <strong class=" ">Old salt</strong> field.</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>If you leave the <strong class=" ">Sign all macros</strong> option <i class=" ">disabled</i>, the system checks the original signatures before re-signing macros. Only macros that have a valid signature under the old salt are re-signed and the identifiers of the macro authors remain unchanged. You need to enter the old salt that was used to generate the security hash of the existing macro expressions in the system.</p>
<ul class=" "><li class=" "><p   
>If your application uses a custom hash salt, enter the original value of the <strong class=" ">CMSHashStringSalt</strong> web.config key.</p>
</li><li class=" "><p   
>If the original hash salt was a connection string, enter the value in format:<br/><i class=" "> Persist Security Info=False;database=DBName;server=ServerName;user id=DBUser;password=pwd;Current Language=English;Connection Timeout=240;</i></p>
</li></ul>        </div>
    </div>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>If you enable<strong class=" "> Sign all macros</strong>, the macro re-signing process skips the signature integrity check and creates new signatures for all macros. You do not need to enter the old salt value in this case. The new signatures contain the name or identity of the user who started the re-signing procedure.</p>
<p   
><strong class=" ">Security warning</strong>: With the <i class=" ">Sign all macros</i> option enabled, the resigning process also includes macros that are unsigned or have invalid signatures. If your system&#39;s data contains invalid macros added by users with insufficient authorization, such macros receive valid signatures and represent potential security threats.</p>
        </div>
    </div>
</li><li class=" "><p   
>Type in the <strong class=" ">New salt</strong> that will be used to re-sign the macros.</p>
<ul class=" "><li class=" "><p   
>By default, the field automatically loads the current application&#39;s hash salt value. To enter a different value, disable the <strong class=" ">Use current salt</strong> option.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Important</strong></p>
<p   
>In order for the system to correctly validate macro signatures, the new hash salt value must match the application&#39;s current salt (the <strong class=" ">CMSHashStringSalt</strong> key value or connection string). Only change the <strong class=" ">New salt</strong> value if you are planning to change your application salt.</p>
        </div>
    </div>
</li></ul></li><li class=" "><p   
>Click <strong class=" ">Update macro signatures</strong>.</p>
</li></ol><p   
>The system replaces the security signature in all occurrences of macros based on the new salt.</p>
        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
