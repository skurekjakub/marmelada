<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Creating a custom payment gateway - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo" />
                </h1>
                <a href="Kentico_11_Documentation_Home.html" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=68881643"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico_11_Documentation_Home.html">Kentico 11 Documentation</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="E-commerce_features.html">E-commerce features</a></li>
                                                                                                         <li class="shortcut"><a href="Customizing_and_developing_your_store.html">Customizing and developing your store</a></li>
                                                                                     <li><a href="Payment-related_customizing.html">Payment-related customizing</a></li>
                                                            </ul>
</div>            <h1 id="src-68881643"> <span>Creating a custom payment gateway</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
        $page.content
<p   
>The Kentico E-commerce Solution allows you to integrate with 3rd-party payment gateways or services. To develop a custom payment gateway:</p>
<ol class=" "><li class=" "><p   
>Create a <a   href="#src-68881643_Creatingacustompaymentgateway-Creatingpaymentgatewayforms">payment gateway form</a> that allows customers to enter any required payment data.</p>
</li><li class=" "><p   
>Create a custom <a   href="#src-68881643_Creatingacustompaymentgateway-Creatingpaymentgatewayproviders">payment gateway provider</a> class that performs the required payment processing.</p>
</li><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Mappinggatewayproviderstoforms">Map the payment gateway provider to the appropriate payment form</a> by registering a custom implementation of the <strong class=" ">IPaymentGatewayFormFactory</strong> interface.</p>
</li><li class=" "><p   
>(Optional) Create an <a   href="#src-68881643_Creatingacustompaymentgateway-HandlingIPNforcustompaymentgateways">IPN handler</a> for your payment gateway.</p>
</li><li class=" "><p   
>Open the <strong class=" ">Store configuration </strong>application in Kentico.</p>
</li><li class=" "><p   
>Switch to the <strong class=" ">Payment methods</strong> tab.</p>
</li><li class=" "><p   
>Create a new <a   href="Configuring_payment_methods.html">payment method</a> using the custom payment gateway provider class.</p>
<p   
><img  class="confluence-embedded-image confluence-content-image-border"  src="images/download/attachments/68881643/creating_custom_payment_method.png" alt="images/download/attachments/68881643/creating_custom_payment_method.png" width="500"  />
        <br/><span class="caption">Creating a custom payment gateway</span>
    </p>
</li></ol><p   
>Customers on your website can now select the custom payment method during checkout and pay for their orders using the given gateway.</p>
    <div  class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Creatingpaymentgatewayforms">Creating payment gateway forms</a></p>
</li><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Creatingpaymentgatewayproviders">Creating payment gateway providers</a></p>
</li><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Mappinggatewayproviderstoforms">Mapping gateway providers to forms</a></p>
</li><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-HandlingIPNforcustompaymentgateways">Handling IPN for custom payment gateways</a></p>
</li><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Example">Example</a></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Creatingthepaymentgatewayform">Creating the payment gateway form</a></p>
</li><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Preparingaprojectforcustomclasses">Preparing a project for custom classes</a></p>
</li><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Creatingthepaymentgatewayprovider">Creating the payment gateway provider</a></p>
</li><li class=" "><p   
><a   href="#src-68881643_Creatingacustompaymentgateway-Mappingthegatewayprovidertotheform">Mapping the gateway provider to the form</a></p>
</li></ul></li></ul><p   
></p>
        </div>
    </div>
    <div  class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p   
><a   href="Configuring_payment_methods.html">Configuring payment methods</a></p>
</li></ul>        </div>
    </div>
    <h3 id="src-68881643_Creatingacustompaymentgateway-Creatingpaymentgatewayforms" class="heading "><span>Creating payment gateway forms</span></h3>
<ol class=" "><li class=" "><p   
>Open your Kentico solution in Visual Studio.</p>
</li><li class=" "><p   
>Create a new web user control (ascx file) in the Kentico web project (<i class=" ">CMS</i> or <i class=" ">CMSApp</i>).</p>
</li><li class=" "><p   
>Add the required form inputs and other content into the control&#39;s markup.</p>
</li><li class=" "><p   
>Set the control class to inherit from the abstract <strong class=" ">CMSPaymentGatewayForm</strong> class (located in the <i class=" ">CMS.Ecommerce.Web.UI</i> namespace).</p>
</li><li class=" "><p   
>Override the following methods of the base class:<br/></p>
<ul class=" "><li class=" "><p   
><strong class=" ">GetPaymentGatewayData()</strong> &ndash; loads the customer&#39;s input from the payment form. Returns the payment data as an <i class=" ">IDictionary&lt;string, object&gt;</i> collection.</p>
</li><li class=" "><p   
><strong class=" ">ValidateData()</strong> &ndash; validates the payment form&#39;s input. We recommend calling the base method in your override, which validates the form&#39;s data using the <i class=" ">ValidateCustomData</i> method of the related payment provider class.</p>
</li><li class=" "><p   
>(Optional)<strong class=" "> OnInitialized()</strong> &ndash; called after the related payment provider class is assigned and initialized. Allows you to access the data of the related order via the payment provider.</p>
</li></ul>    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Notes</strong></p>
<ul class=" "><li class=" "><p   
>The payment data (personal information, etc.) is not saved into the database, only passed to the related payment provider class.</p>
</li><li class=" "><p   
>Use the <strong class=" ">PaymentProvider</strong> property to access the instance of the payment provider class related to the form (within the <i class=" ">OnInitialized</i> or <i class=" ">ValidateData</i> methods).</p>
</li></ul>        </div>
    </div>
</li></ol>    <h3 id="src-68881643_Creatingacustompaymentgateway-Creatingpaymentgatewayproviders" class="heading "><span>Creating payment gateway providers</span></h3>
<ol class=" "><li class=" "><p   
>Create a new custom class inheriting from the <strong class=" ">CMSPaymentGatewayProvider</strong> abstract class (located in the <i class=" ">CMS.Ecommerce</i> namespace).</p>
    <div  class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Class location</strong><br/></p>
<p   
>We recommend creating a new assembly (Class library project) in your Kentico solution and including your custom classes there. Add the appropriate references to both the assembly and the main Kentico web project. For more information, see <a   href="Best_practices_for_customization.html">Best practices for customization</a>.<br/></p>
        </div>
    </div>
</li><li class=" "><p   
>Make the class implement <strong class=" ">one or both</strong> of the following interfaces and add the required members:</p>
<ul class=" "><li class=" "><p   
><strong class=" ">IDirectPaymentGatewayProvider</strong> &ndash; for transactions that immediately mark funds for transfer/settlement during the customer&#39;s initial payment.<br/></p>
<ul class=" "><li class=" "><p   
><strong class=" ">ProcessPayment(IDictionary&lt;string, object&gt;)</strong> &ndash; method that processes any input data from the payment form and sends the payment request to the gateway. Set and return the <a   href="Working_with_payment_results.html">payment result</a> using the provider&#39;s <i class=" ">PaymentResult</i> property.</p>
</li></ul></li><li class=" "><p   
><strong class=" ">IDelayedPaymentGatewayProvider</strong> &ndash; for transactions that initially only authorize the payment and capture of funds is done at a later time.<br/></p>
<ul class=" "><li class=" "><p   
><strong class=" ">IsPaymentAuthorized</strong> &ndash; bool property indicating whether the processed payment represents a transaction that was successfully authorized for later capture. We recommend using the <a   href="Working_with_payment_results.html">payment result data</a> to store and evaluate the authorization status (i.e. the <i class=" ">PaymentIsAuthorized</i> flag of the provider&#39;s <i class=" ">PaymentResult</i> property).</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">bool</code><code class="plain"> IsPaymentAuthorized</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">	</code><code class="keyword">get</code></div>
<div class="line"><code class="plain">	{</code></div>
<div class="line"><code class="plain">		</code><code class="keyword">return</code><code class="plain"> PaymentResult != </code><code class="keyword">null</code><code class="plain"> &amp;&amp; PaymentResult.PaymentIsAuthorized;</code></div>
<div class="line"><code class="plain">	}</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p   
><strong class=" ">AuthorizePayment</strong><strong class=" ">(IDictionary&lt;string, object&gt;)</strong> &ndash; method that processes any input data from the payment form and sends the authorization request to the gateway. Set and return the <a   href="Working_with_payment_results.html">payment result</a> using the provider&#39;s <i class=" ">PaymentResult</i> property.</p>
</li><li class=" "><p   
><strong class=" ">CapturePayment()</strong> &ndash; method that performs capture of funds for orders that already have successfully authorized payments. Triggered automatically when the <i class=" ">Capture payment</i> button is clicked when <a   href="Orders.html">editing orders</a> with the corresponding payment method. You need to set and return the <a   href="Working_with_payment_results.html">payment result</a> using the provider&#39;s <i class=" ">PaymentResult</i> property.</p>
</li></ul></li></ul></li><li class=" "><p   
>Override the following methods of the base class:<br/></p>
<ul class=" "><li class=" "><p   
><strong class=" ">ValidateCustomData(IDictionary&lt;string, object&gt;)</strong> &ndash; validates input data to ensure the correctness of custom payment parameters. Typically, this method is called from the <i class=" ">ValidateData</i> method of the related payment gateway form.</p>
</li><li class=" "><p   
><strong class=" ">UseDelayedPayment()</strong> &ndash; only necessary if your provider supports delayed capture of funds (i.e. implements the <i class=" ">IDelayedPaymentGatewayProvider</i> interface). If your provider allows only delayed capture transactions, return a <i class=" ">true</i> value. For providers that support both direct payments and delayed capture, use the method to control which transaction type is used (for example, you can load the returned value from a <a   href="Adding_custom_website_settings.html">custom setting</a>).</p>
</li></ul>    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Notes</strong></p>
<ul class=" "><li class=" "><p   
>You can access the data of the <a   href="Orders.html">order</a> (and shopping cart) related to the processed payment using the provider&#39;s <strong class=" ">Order</strong> property.</p>
</li><li class=" "><p   
>If you need to directly assign an order whose payment you wish to process, set the order&#39;s identifier into the provider&#39;s <strong class=" ">OrderId</strong> property.</p>
</li><li class=" "><p   
>Use the <strong class=" ">PaymentResult </strong>property (<i class=" ">PaymentResultInfo</i>) to get or set the <a   href="Working_with_payment_results.html">payment results</a>.</p>
</li><li class=" "><p   
>Call the <strong class=" ">UpdateOrderPaymentResult()</strong> method to save the current payment results into the order. The method also automatically performs the following:</p>
<ul class=" "><li class=" "><p   
>Sets the time stamp (payment date) and the payment method values of the results.</p>
</li><li class=" "><p   
>Changes the order&#39;s <a   href="Order_statuses.html">status</a> to the value configured in the related <a   href="Reference_-_Payment_methods.html">payment method</a> for successful, failed or authorized payments .</p>
</li></ul></li><li class=" "><p   
>If the payment transaction fails before the customer leaves the payment form, you can display an appropriate error message by setting the message text into the provider&#39;s <strong class=" ">ErrorMessage</strong> property.</p>
</li></ul>        </div>
    </div>
</li></ol>    <h3 id="src-68881643_Creatingacustompaymentgateway-Mappinggatewayproviderstoforms" class="heading "><span>Mapping gateway providers to forms</span></h3>
<p   
>The system maps payment gateway providers to the appropriate payment form by using the registered implementation of the <strong class=" ">IPaymentGatewayFormFactory</strong> interface.</p>
<p   
>To perform correct form mapping for your custom gateway providers:</p>
<ol class=" "><li class=" "><p   
>Create a new custom class inheriting from <strong class=" ">PaymentGatewayFormFactory</strong> (the default <i class=" ">IPaymentGatewayFormFactory</i> implementation, located in the <i class=" ">CMS.Ecommerce.Web.UI</i> namespace).</p>
</li><li class=" "><p   
>Override the <strong class=" ">GetPath</strong> method and evaluate the type of the method&#39;s <i class=" ">CMSPaymentGatewayProvider</i> parameter.</p>
<ul class=" "><li class=" "><p   
>For your custom gateway provider types, return the path to the corresponding custom gateway form (control).</p>
</li><li class=" "><p   
>Call the base <i class=" ">GetPath</i> method for all other gateway provider types.</p>
</li></ul></li><li class=" "><p   
>Register your implementation of the interface using the <strong class=" ">RegisterImplementation</strong> assembly attribute.</p>
</li></ol>    <h3 id="src-68881643_Creatingacustompaymentgateway-HandlingIPNforcustompaymentgateways" class="heading "><span>Handling IPN for custom payment gateways</span></h3>
<p   
>If you wish to use <a  class="external-link" href="https://en.wikipedia.org/wiki/Instant_payment_notification">Instant Payment Notification (IPN)</a> with your payment gateway, you need to create a custom HTTP handler that performs the required communication between your Kentico application and the payment service. Do not handle IPN requests using standard pages (web forms), otherwise you will encounter security errors due to invalid <a   href="Cross_site_request_forgery_%28CSRF_XSRF%29.html">CSRF tokens</a>.</p>
<p   
>See also: <a  class="external-link" href="http://devnet.kentico.com/articles/payment-gateways-and-csrf-protection">Payment Gateways and CSRF protection</a></p>
    <h3 id="src-68881643_Creatingacustompaymentgateway-Example" class="heading "><span>Example</span></h3>
<p   
>The following example demonstrates how to implement a custom payment gateway in Kentico. The example allows customers to pay for orders using an external gateway or service (the service URLs in the example are fictional). The samples include two variants of the gateway provider class &ndash; one for direct payment transactions and another for authorization transactions with delayed capture of funds.</p>
<p   
>The example assumes the following payment model:</p>
<ol class=" "><li class=" "><p   
>In the payment step of the <a   href="Configuring_steps_of_the_checkout_process.html">checkout process</a>, the system asks the customer for an email address identifying their payment account.</p>
</li><li class=" "><p   
>After the customer confirms payment, the system validates the email address and redirects the user to the external gateway&#39;s payment page.</p>
</li><li class=" "><p   
>The customer finishes the payment on the external page, and the gateway sends a notification about the result of the payment.</p>
</li><li class=" "><p   
>A custom HTTP handler accepts the notification and calls a method from the provider class to process and save the results (the external gateway is fictional, so this part of the process is not implemented in the example).</p>
</li><li class=" "><p   
>If using the delayed capture variant of the provider class, the store&#39;s administrators need to manually capture funds at a later time for orders with successfully authorized payments.</p>
</li></ol>    <h4 id="src-68881643_Creatingacustompaymentgateway-Creatingthepaymentgatewayform" class="heading "><span>Creating the payment gateway form</span></h4>
<p   
>Prepare a payment form with one input field where customer enter an email address identifying their account with the fictional payment gateway:</p>
<ol class=" "><li class=" "><p   
>Open your Kentico solution in Visual Studio.</p>
</li><li class=" "><p   
>Create a <strong class=" ">Web User Control</strong> named <i class=" ">CustomGatewayForm.ascx</i> in your site&#39;s folder under the web project root (for example the <i class=" ">DancingGoat</i> folder for the Dancing Goat sample site).</p>
</li><li class=" "><p   
>Add the following markup to the control:</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>For web application projects, rename the <i class=" ">CodeFile</i> attribute in the Control directive to <i class=" ">Codebehind</i>.</p>
        </div>
    </div>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;%@ Control Language="C#" AutoEventWireup="true" CodeFile="CustomGatewayForm.ascx.cs" Inherits="DancingGoat_CustomGatewayForm" %&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">h4</code><code class="plain">&gt;Payment account details&lt;/</code><code class="keyword">h4</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">asp</code><code class="plain">:Label </code><code class="color1">ID</code><code class="plain">=</code><code class="string">"lblError"</code><code class="plain"> </code><code class="color1">runat</code><code class="plain">=</code><code class="string">"server"</code><code class="plain"> </code><code class="color1">EnableViewState</code><code class="plain">=</code><code class="string">"false"</code><code class="plain"> </code><code class="color1">CssClass</code><code class="plain">=</code><code class="string">"ErrorLabel"</code><code class="plain"> </code><code class="color1">Visible</code><code class="plain">=</code><code class="string">"false"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">asp</code><code class="plain">:Label </code><code class="color1">ID</code><code class="plain">=</code><code class="string">"lblPaymentAccountEmail"</code><code class="plain"> </code><code class="color1">EnableViewState</code><code class="plain">=</code><code class="string">"false"</code><code class="plain"> </code><code class="color1">runat</code><code class="plain">=</code><code class="string">"server"</code><code class="plain"> </code><code class="color1">Text</code><code class="plain">=</code><code class="string">"Account email address:"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">asp</code><code class="plain">:TextBox </code><code class="color1">ID</code><code class="plain">=</code><code class="string">"txtPaymentAccountEmail"</code><code class="plain"> </code><code class="color1">runat</code><code class="plain">=</code><code class="string">"server"</code><code class="plain"> /&gt;</code></div>
</div>
    </div>
</li><li class=" "><p   
>Switch to the control&#39;s code behind and add the following code:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> System;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> System.Collections.Generic;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce.Web.UI;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">partial</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> DancingGoat_CustomGatewayForm : CMSPaymentGatewayForm</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Called automatically after the related payment provider is assigned to the form and initialized.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">protected</code><code class="plain"> </code><code class="keyword">override</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> OnInitialized()</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Attempts to get a default email address value from the Kentico customer object</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">string</code><code class="plain"> customerEmail = CustomerInfoProvider.GetCustomerInfo(PaymentProvider.Order.OrderCustomerID)?.CustomerEmail;        </code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (!String.IsNullOrEmpty(customerEmail))</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            txtPaymentAccountEmail.Text = customerEmail;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Loads the customer's input from the payment form.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">override</code><code class="plain"> IDictionary&lt;</code><code class="keyword">string</code><code class="plain">, </code><code class="keyword">object</code><code class="plain">&gt; GetPaymentGatewayData()</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">var</code><code class="plain"> paymentData = </code><code class="keyword">new</code><code class="plain"> Dictionary&lt;</code><code class="keyword">string</code><code class="plain">, </code><code class="keyword">object</code><code class="plain">&gt;();</code></div>
<div class="line"><code class="plain">        paymentData.Add(</code><code class="string">"PaymentAccountEmail"</code><code class="plain">, txtPaymentAccountEmail.Text.Trim());</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> paymentData;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Used for validation of the payment form's inputs.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;    </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">override</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> ValidateData()</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// The 'ValidateData' method of the base class delegates the validation logic to the related payment provider</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// First gets the form's data using the 'GetPaymentGatewayData()' method</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// and then validates it by calling the provider's 'ValidateCustomData' method</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">string</code><code class="plain"> error = </code><code class="keyword">base</code><code class="plain">.ValidateData();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (!String.IsNullOrEmpty(error))</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            lblError.Visible = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            lblError.Text = error;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> error;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ol><p   
><img  class="confluence-embedded-image confluence-content-image-border"  src="images/download/attachments/68881643/custom_payment_gateway_form.png" alt="images/download/attachments/68881643/custom_payment_gateway_form.png"   />
        <br/><span class="caption">Custom payment gateway form</span>
    </p>
    <h4 id="src-68881643_Creatingacustompaymentgateway-Preparingaprojectforcustomclasses" class="heading "><span>Preparing a project for custom classes</span></h4>
<p   
>Prepare a separate project for custom classes in your Kentico solution:</p>
<ol class=" "><li class=" "><p   
>Create a new <i class=" ">Class Library</i> project in the Kentico solution (or reuse an existing custom project).</p>
</li><li class=" "><p   
>Add references to the required Kentico libraries (DLLs) for the new project:<br/></p>
<ol class=" "><li class=" "><p   
>Right-click the project and select <strong class=" ">Add -&gt; Reference</strong>.</p>
</li><li class=" "><p   
>Select the <strong class=" ">Browse</strong> tab of the <strong class=" ">Reference manager</strong> dialog, click <strong class=" ">Browse</strong> and navigate to the <i class=" "><strong class=" ">Lib</strong> </i>folder of your Kentico web project.</p>
</li><li class=" "><p   
>Add references to the following libraries (and any others that you may need in your custom code):</p>
<ul class=" "><li class=" "><p   
><strong class=" ">CMS.Base.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Core.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.DataEngine.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Ecommerce.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Ecommerce.Web.UI.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Helpers.dll</strong></p>
</li></ul></li></ol></li><li class=" "><p   
>Reference the custom project from the Kentico web project <i class=" ">(CMSApp</i> or <i class=" ">CMS)</i>.</p>
</li><li class=" "><p   
>Right-click the project in the <strong class=" ">Solution Explorer</strong> and select <strong class=" ">Manage NuGet Packages</strong>.</p>
</li><li class=" "><p   
>Install the <strong class=" ">System.Net.Http.Formatting.Extension</strong> package (used in the example for serialization of data posted to the external gateway).</p>
</li><li class=" "><p   
>Edit the custom project&#39;s <strong class=" ">AssemblyInfo.cs</strong> file (in the <i class=" ">Properties</i> folder).</p>
</li><li class=" "><p   
>Add the <strong class=" ">AssemblyDiscoverable</strong> assembly attribute:<br/></p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[assembly:AssemblyDiscoverable]</code></div>
</div>
    </div>
</li></ol>    <h4 id="src-68881643_Creatingacustompaymentgateway-Creatingthepaymentgatewayprovider" class="heading "><span>Creating the payment gateway provider</span></h4>
<p   
>Add the payment gateway provider class under the custom project:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Direct payment example</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Direct payment example" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> System.Collections.Generic;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Helpers;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomGatewayProvider : CMSPaymentGatewayProvider, IDirectPaymentGatewayProvider</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Validates data submitted by the customer through the related payment form.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;    </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">override</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> ValidateCustomData(IDictionary&lt;</code><code class="keyword">string</code><code class="plain">, </code><code class="keyword">object</code><code class="plain">&gt; paymentData)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the email address value from the submitted payment form</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">string</code><code class="plain"> paymentAccountEmail = ValidationHelper.GetString(paymentData[</code><code class="string">"PaymentAccountEmail"</code><code class="plain">], </code><code class="string">""</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        </code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Checks whether the value is a valid email address</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (!ValidationHelper.IsEmail(paymentAccountEmail))</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> </code><code class="string">"Please enter a valid email address identifying your payment account."</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">string</code><code class="plain">.Empty;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Processes the payment after a customer submits valid data through the payment form.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> PaymentResultInfo ProcessPayment(IDictionary&lt;</code><code class="keyword">string</code><code class="plain">, </code><code class="keyword">object</code><code class="plain">&gt; paymentData)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Prepares the URL of the external gateway's payment page</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">string</code><code class="plain"> gatewayUrl = </code><code class="string">"https://www.custompayments.com/service/directpayment"</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Adds query string parameters to the payment page URL with data for the gateway</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Most parameter values are loaded from the related order, the payment account email is from the payment form        </code></div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.AddParameterToUrl(gatewayUrl, </code><code class="string">"orderid"</code><code class="plain">, OrderId.ToString());</code></div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.AddParameterToUrl(gatewayUrl, </code><code class="string">"price"</code><code class="plain">, Order.OrderGrandTotal.ToString());</code></div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.AddParameterToUrl(gatewayUrl, </code><code class="string">"currency"</code><code class="plain">, CurrencyInfoProvider.GetCurrencyInfo(Order.OrderCurrencyID).CurrencyCode);</code></div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.AddParameterToUrl(gatewayUrl, </code><code class="string">"accountEmail"</code><code class="plain">, ValidationHelper.GetString(paymentData[</code><code class="string">"PaymentAccountEmail"</code><code class="plain">], </code><code class="string">""</code><code class="plain">));</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.UrlEncodeQueryString(gatewayUrl);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Sets the external gateway URL into the payment results</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Customers are redirected to this URL to finish the payment after they successfully submit the payment form</code></div>
<div class="line"><code class="plain">        PaymentResult.PaymentApprovalUrl = gatewayUrl;</code></div>
<div class="line"><code class="plain">        PaymentResult.PaymentDescription = </code><code class="string">"Customer payment approval pending"</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Saves the payment result to the related order</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Automatically sets the PaymentResult time stamp (date) and payment method properties</code></div>
<div class="line"><code class="plain">        UpdateOrderPaymentResult();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Returns the partially set payment results. </code></div>
<div class="line"><code class="plain">        </code><code class="comments">// The customer finishes the payment on an external page, so the example assumes that a HTTP handler (IPN)</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// later processes the gateway's reply, and calls the provider's 'ProcessDirectPaymentReply' method.</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> PaymentResult;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Processes the payment results based on a reply from the payment gateway.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// For example, the method can be called from a custom IPN handler that accepts responses/notifications from</code></div>
<div class="line"><code class="plain">	</code><code class="comments">/// the external gateway's responses/notifications.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;    </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> ProcessDirectPaymentReply(</code><code class="keyword">bool</code><code class="plain"> success, </code><code class="keyword">string</code><code class="plain"> transactionId)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (success)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Sets the payment result for successful transactions</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentIsCompleted = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentDescription = </code><code class="string">"Payment complete"</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentTransactionID = transactionId;            </code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">else</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Sets the payment result for failed transactions</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentIsFailed = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentDescription = </code><code class="string">"Payment failed"</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Saves the payment result to the related order</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Moves the order to the status configured for successful or failed payments</code></div>
<div class="line"><code class="plain">        UpdateOrderPaymentResult();        </code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Delayed capture example</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Delayed capture example" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> System.Collections.Generic;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> System.Net.Http;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Helpers;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomDelayedCaptureGatewayProvider : CMSPaymentGatewayProvider, IDelayedPaymentGatewayProvider</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Class used for JSON serialization of data posted during capture transactions</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CaptureData</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> TransactionId { </code><code class="keyword">get</code><code class="plain">; </code><code class="keyword">set</code><code class="plain">; }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Validates data submitted by the customer through the related payment form.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;    </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">override</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> ValidateCustomData(IDictionary&lt;</code><code class="keyword">string</code><code class="plain">, </code><code class="keyword">object</code><code class="plain">&gt; paymentData)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the email address value from the submitted payment form</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">string</code><code class="plain"> paymentAccountEmail = ValidationHelper.GetString(paymentData[</code><code class="string">"PaymentAccountEmail"</code><code class="plain">], </code><code class="string">""</code><code class="plain">);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Checks whether the value is a valid email address</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (!ValidationHelper.IsEmail(paymentAccountEmail))</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> </code><code class="string">"Please enter a valid email address identifying your payment account."</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">string</code><code class="plain">.Empty;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Indicates whether the provider uses delayed capture of funds.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// You can parameterize the result (for example using a custom setting) for provider classes that allow both direct payments</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// and delayed capture (i.e. implement both the IDirectPaymentGatewayProvider and IDelayedPaymentGatewayProvider interfaces).</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;    </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">override</code><code class="plain"> </code><code class="keyword">bool</code><code class="plain"> UseDelayedPayment()</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Indicates whether the processed payment represents a transaction that was successfully authorized for later capture.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Required to control the visibility of the 'Capture payment' button in the order editing interface.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">bool</code><code class="plain"> IsPaymentAuthorized</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">get</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> PaymentResult != </code><code class="keyword">null</code><code class="plain"> &amp;&amp; PaymentResult.PaymentIsAuthorized;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    </code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Processes the authorization transaction after a customer submits valid data through the payment form.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> PaymentResultInfo AuthorizePayment(IDictionary&lt;</code><code class="keyword">string</code><code class="plain">, </code><code class="keyword">object</code><code class="plain">&gt; paymentData)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Prepares the URL of the external gateway's payment/authorization page</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">string</code><code class="plain"> gatewayUrl = </code><code class="string">"https://www.custompayments.com/service/authorize"</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Adds query string parameters to the payment page URL with data for the gateway</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Most parameter values are loaded from the related order, the payment account email is from the payment form        </code></div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.AddParameterToUrl(gatewayUrl, </code><code class="string">"orderid"</code><code class="plain">, OrderId.ToString());</code></div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.AddParameterToUrl(gatewayUrl, </code><code class="string">"price"</code><code class="plain">, Order.OrderGrandTotal.ToString());</code></div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.AddParameterToUrl(gatewayUrl, </code><code class="string">"currency"</code><code class="plain">, CurrencyInfoProvider.GetCurrencyInfo(Order.OrderCurrencyID).CurrencyCode);</code></div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.AddParameterToUrl(gatewayUrl, </code><code class="string">"accountEmail"</code><code class="plain">, ValidationHelper.GetString(paymentData[</code><code class="string">"PaymentAccountEmail"</code><code class="plain">], </code><code class="string">""</code><code class="plain">));</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        gatewayUrl = URLHelper.UrlEncodeQueryString(gatewayUrl);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Sets the external gateway URL into the payment results</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Customers are redirected to this URL to finish the authorization after they successfully submit the payment form</code></div>
<div class="line"><code class="plain">        PaymentResult.PaymentApprovalUrl = gatewayUrl;</code></div>
<div class="line"><code class="plain">        PaymentResult.PaymentDescription = </code><code class="string">"Customer authorization approval pending"</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Saves the payment result to the related order</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Automatically sets the PaymentResult time stamp (date) and payment method properties</code></div>
<div class="line"><code class="plain">        UpdateOrderPaymentResult();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Returns the partially set payment results. </code></div>
<div class="line"><code class="plain">        </code><code class="comments">// The customer finishes the payment on an external page, so the example assumes that a HTTP handler (IPN)</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// later processes the gateway's reply, and calls the provider's 'ProcessAuthorizationReply' method.</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> PaymentResult;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Processes the payment results for authorization transactions based on a reply from the payment gateway.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// For example, such methods can be called from a custom IPN handler that accepts the response/notification from</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// the external payment gateway.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;  </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> ProcessAuthorizationReply(</code><code class="keyword">bool</code><code class="plain"> success, </code><code class="keyword">string</code><code class="plain"> transactionId)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (success)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Sets the payment result for successful authorization transactions</code></div>
<div class="line"><code class="plain">			PaymentResult.PaymentIsAuthorized = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">			PaymentResult.PaymentDescription = </code><code class="string">"Payment authorized"</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentTransactionID = transactionId;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">else</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Sets the payment result for failed authorization transactions</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentIsFailed = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">			PaymentResult.PaymentDescription = </code><code class="string">"Payment authorization failed"</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Saves the payment result to the related order</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Moves the order to the status configured for authorized or failed payments</code></div>
<div class="line"><code class="plain">		UpdateOrderPaymentResult();</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Performs capture of funds for successfully authorized payments.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Triggered when the 'Capture payment' button is clicked when editing an order using the corresponding payment method.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> PaymentResultInfo CapturePayment()</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Prepares the URL of the external gateway's payment capture service</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">string</code><code class="plain"> gatewayUrl = </code><code class="string">"https://www.custompayments.com/service/capture"</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        HttpResponseMessage response = </code><code class="keyword">null</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">using</code><code class="plain"> (</code><code class="keyword">var</code><code class="plain"> client = </code><code class="keyword">new</code><code class="plain"> HttpClient())</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Prepares an object containing payment capture parameters for the gateway (suitable for JSON serialization)</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">var</code><code class="plain"> captureData = </code><code class="keyword">new</code><code class="plain"> CaptureData</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Gets the transaction ID from the order's payment result data</code></div>
<div class="line"><code class="plain">                TransactionId = PaymentResult.PaymentTransactionID</code></div>
<div class="line"><code class="plain">            };</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">            </code><code class="comments">// Sends a POST request to the payment capture service with the payment parameters</code></div>
<div class="line"><code class="plain">            response = client.PostAsJsonAsync(gatewayUrl, captureData).Result;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Marks the payment result as finished if the fund capture is successful</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// The example only checks the status code of the HTTP response</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// For real payment gateways, you need to process the response content as required by the gateway's API</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (response.StatusCode == System.Net.HttpStatusCode.OK)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentIsCompleted = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentDescription = </code><code class="string">"Payment captured"</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">else</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentIsFailed = </code><code class="keyword">false</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            PaymentResult.PaymentDescription = </code><code class="string">"Payment capture failed"</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Saves the payment result to the related order</code></div>
<div class="line"><code class="plain">        UpdateOrderPaymentResult();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> PaymentResult;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <div  class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>To process payment results from custom HTTP handlers that accept notifications from the external payment gateway (IPN), create an instance of your payment gateway provider class and call the required methods. For example:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Helpers;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">...</code></div>
<div class="line"> </div>
<div class="line"><code class="comments">// Gets data from the payment gateway's notification request</code></div>
<div class="line"><code class="comments">// This example uses URL parameters (the implementation depends on the gateway's API)</code></div>
<div class="line"><code class="keyword">string</code><code class="plain"> transactionId = URLHelper.GetUrlParameter(RequestContext.CurrentURL, </code><code class="string">"transactionid"</code><code class="plain">);</code></div>
<div class="line"><code class="keyword">int</code><code class="plain"> orderId = ValidationHelper.GetInteger(URLHelper.GetUrlParameter(RequestContext.CurrentURL, </code><code class="string">"orderid"</code><code class="plain">), 0);</code></div>
<div class="line"> </div>
<div class="line"><code class="comments">// Gets the Kentico order object related to the payment</code></div>
<div class="line"><code class="plain">OrderInfo order = OrderInfoProvider.GetOrderInfo(orderId);</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">if</code><code class="plain"> (order != </code><code class="keyword">null</code><code class="plain">)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">	</code><code class="comments">// Prepares an instance of the payment gateway provider used by the order's payment method</code></div>
<div class="line"><code class="plain">	CustomGatewayProvider customProvider = CMSPaymentGatewayProvider.GetPaymentGatewayProvider&lt;CustomGatewayProvider&gt;(order.OrderPaymentOptionID);</code></div>
<div class="line"><code class="plain">	customProvider.OrderId = orderId;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">	</code><code class="comments">// Calls the provider's method for processing payment results</code></div>
<div class="line"><code class="plain">	customProvider.ProcessDirectPaymentReply(</code><code class="keyword">true</code><code class="plain">, transactionId);</code></div>
<div class="line"><code class="plain">}   </code></div>
</div>
    </div>
        </div>
    </div>
    <h4 id="src-68881643_Creatingacustompaymentgateway-Mappingthegatewayprovidertotheform" class="heading "><span>Mapping the gateway provider to the form</span></h4>
<p   
>Create and register a custom implementation of the <strong class=" ">IPaymentGatewayFormFactory</strong> interface to map your gateway provider to the correct payment form. Add the class under your custom project:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce.Web.UI;</code></div>
<div class="line"> </div>
<div class="line"><code class="comments">// Registers the custom implementation of IPaymentGatewayFormFactory</code></div>
<div class="line"><code class="plain">[assembly: RegisterImplementation(</code><code class="keyword">typeof</code><code class="plain">(IPaymentGatewayFormFactory), </code><code class="keyword">typeof</code><code class="plain">(CustomPaymentGatewayFormFactory))]</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomPaymentGatewayFormFactory : PaymentGatewayFormFactory</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">protected</code><code class="plain"> </code><code class="keyword">override</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> GetPath(CMSPaymentGatewayProvider provider)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">		</code><code class="comments">// Maps the path to the correct payment gateway form for the custom gateway providers</code></div>
<div class="line"><code class="plain">		</code><code class="keyword">if</code><code class="plain"> ((provider </code><code class="keyword">is</code><code class="plain"> CustomGatewayProvider) || (provider </code><code class="keyword">is</code><code class="plain"> CustomDelayedCaptureGatewayProvider))</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> </code><code class="string">"~/DancingGoat/CustomGatewayForm.ascx"</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">else</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">			</code><code class="comments">// Calls the base method to map the paths of the default payment gateways</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">base</code><code class="plain">.GetPath(provider);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>Save all changes and <strong class=" ">Build</strong> the custom project.</p>
<p   
>You can now create a new <a   href="Configuring_payment_methods.html">payment method</a> using the custom payment gateway provider class.</p>
        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
