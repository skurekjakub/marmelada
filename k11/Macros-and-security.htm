<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Macros and security - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script> 
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo" />
                </h1>
                <a href="Kentico-11-Documentation-Home.htm" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=68881114"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico-11-Documentation-Home.htm">Kentico 11 Documentation</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="Securing-websites.htm">Securing websites</a></li>
                                                                                     <li><a href="Developing-secure-websites.htm">Developing secure websites</a></li>
                                                            </ul>
</div>            <h1 id="src-68881114"> <span>Macros and security</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
<p   
>Macros are an essential part of Kentico. You can read more about them in the <a   href="k11/Macro-expressions.htm">Macro expressions</a> chapter. This page focuses on the security mechanisms and best practices related to macros.</p>
    <h3 id="src-68881114_Macrosandsecurity-Signingmacros" class="heading "><span>Signing macros</span></h3>
<p   
>Whenever a user saves a complex macro expression, the system automatically adds a security signature. This signature contains an <strong class=" ">identifier</strong> of the macro&#39;s author (the user name or an assigned macro identity) and a <strong class=" ">hash</strong> of the given expression.</p>
<p   
>You can recognize signed macro expressions by the <strong class=" ">#</strong> character, which the system automatically inserts before the closing <strong class=" ">%}</strong> parentheses when saving the text containing the macro:</p>
<ul class=" "><li class=" "><p   
><i class=" ">{%CurrentSite.SiteID #%}</i></p>
</li></ul><p   
>For illustration, a signed macro may look like this in the database:</p>
<ul class=" "><li class=" "><p   
><i class=" ">{%CurrentSite.SiteID|(user)administrator|(hash)9056b7b76629a47a660c40cc2e5b0d92a13d0f9bce178847ca412c3a585552a1%}<br/></i>&ndash; OR &ndash;</p>
</li><li class=" "><p   
><i class=" ">{%CurrentSite.SiteID|(identity)GlobalAdministrator|(hash)e3402fe14374ab15d119dddbb6c831ce3d2ef55bd8e70ce8eb80994f4e6ad18b%}</i><br/><br/></p>
</li></ul>    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Hashing is omitted when submitting very simple macros (e.g., {%FullName%}). Macros are signed only when they contain an indexer or a dot.</p>
        </div>
    </div>
<p   
>The system checks the macro signature when accessing an object through a different object (for example the user settings of a user object) and evaluates whether the user (identified by the signature) has <strong class=" ">permissions</strong> to execute the macro.</p>
<p   
>The best practice is to use the least privilege approach &ndash; submit macros signed by a user who has access only to the required objects and nothing else.</p>
    <div  class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="k11/#src-68881114_Macrosandsecurity-Signingmacros">Signing macros</a></p>
</li><li class=" "><p   
><a   href="k11/#src-68881114_Macrosandsecurity-SQLinjections">SQL injections</a></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="k11/#src-68881114_Macrosandsecurity-SQLinjectionprotectioninwebpartproperties">SQL injection protection in web part properties</a></p>
</li><li class=" "><p   
><a   href="k11/#src-68881114_Macrosandsecurity-SQLinjectionprotectionoutsideofwebpartproperties">SQL injection protection outside of web part properties</a></p>
</li></ul></li><li class=" "><p   
><a   href="k11/#src-68881114_Macrosandsecurity-Outputencodingofmacros">Output encoding of macros</a></p>
</li><li class=" "><p   
><a   href="k11/#src-68881114_Macrosandsecurity-Writingcustommacromethods">Writing custom macro methods</a></p>
</li><li class=" "><p   
><a   href="k11/#src-68881114_Macrosandsecurity-Unsafemacros">Unsafe macros</a></p>
</li></ul><p   
></p>
        </div>
    </div>
    <div  class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p   
><a   href="k11/Macro-expressions.htm">Macro expressions</a></p>
</li></ul>        </div>
    </div>
    <h3 id="src-68881114_Macrosandsecurity-SQLinjections" class="heading "><span>SQL injections</span></h3>
<p   
>Macros can often become part of SQL queries, for example in <i class=" ">WhereCondition</i> and <i class=" ">OrderBy</i> fields of web part properties, which can lead to SQL injection vulnerability.</p>
    <h4 id="src-68881114_Macrosandsecurity-SQLinjectionprotectioninwebpartproperties" class="heading "><span>SQL injection protection in web part properties</span></h4>
<p   
>Some web part properties are secured against SQL injection attacks, which may affect how macros are resolved in specific cases. By default, this is applied to macros entered into the <strong class=" ">WhereCondition</strong>, <strong class=" ">OrderBy</strong> and <strong class=" ">Columns</strong> web part properties.</p>
<p   
>If the macro returns a string value that contains single quote characters (&#39;), they will be escaped and replaced by two single quotes (&#39;&#39;). This may cause an SQL syntax error if you are using the macro to dynamically insert a part of a query, such as a WHERE clause.</p>
<p   
>It is possible to disable single quote escaping for a specific macro expression by adding the <strong class=" ">handlesqlinjection </strong>parameter and setting its value to <i class=" ">false</i>:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">{% ... |(handlesqlinjection)</code><code class="keyword">false</code><code class="plain"> %}</code></div>
</div>
    </div>
<p   
>To disable SQL escaping globally for all properties of a specific type of web part, edit its code behind file (e.g. <i class=" ">~/CMSWebParts/Viewers/Documents/cmsrepeater.ascx.cs</i> for the <strong class=" ">Repeater</strong> web part) and add the following line of code into the <strong class=" ">SetupControl()</strong> method:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">this</code><code class="plain">.SQLProperties = </code><code class="string">""</code><code class="plain">;</code></div>
</div>
    </div>
<p   
>The <strong class=" ">SQLProperties</strong> property is inherited from the <strong class=" ">CMSAbstractWebPart</strong> base class by all web parts, but you can override its value to set which properties the system protects.</p>
<p   
>If you wish to enable SQL escaping for additional web part properties, enter their names into the SQLProperties value separated by semicolons, for example:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">this</code><code class="plain">.SQLProperties = </code><code class="string">"wherecondition;orderby;columns;sqlquery"</code><code class="plain">;</code></div>
</div>
    </div>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Disabling SQL protection may create security vulnerabilities if the macro resolves its value according to data that can be modified by the website&#39;s users, such as in the case of query string macros.</p>
        </div>
    </div>
    <h4 id="src-68881114_Macrosandsecurity-SQLinjectionprotectionoutsideofwebpartproperties" class="heading "><span>SQL injection protection outside of web part properties</span></h4>
<p   
>If you are using macros outside of web part properties or you have disabled SQL escaping, then you need to use the SQLEscape method to handle SQL macros.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">WHERE</code><code class="plain"> UserName </code><code class="color1">LIKE</code><code class="plain"> </code><code class="string">'%{% SQLEscape(QueryString.GetValue("test", ""))#%}%'</code></div>
</div>
    </div>
<p   
>However, if you expect a different data type than string (for example an integer), you need to convert the macro to the correct data type. The SQLEscape method is useless in this case.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">WHERE</code><code class="plain"> UserID = {% ToInt(QueryString.GetValue(</code><code class="string">"test"</code><code class="plain">, </code><code class="string">""</code><code class="plain">), 0)#%}</code></div>
</div>
    </div>
    <h3 id="src-68881114_Macrosandsecurity-Outputencodingofmacros" class="heading "><span>Output encoding of macros</span></h3>
<p   
>Macro encoding is an essential protection against XSS. You must encode output macros properly, unless you want to display some HTML code using the particular macro. There are several methods for encoding macros in Kentico:</p>
<ul class=" "><li class=" "><p   
>{% UrlEncode(CurrentUser.FullName) %} &ndash; macro is encoded into the query URL.</p>
</li><li class=" "><p   
>{% HTMLEncode(CurrentUser.FullName) %} &ndash; macro is a part of standard page output text and text between HTML tags.</p>
</li><li class=" "><p   
>{% JSEscape(CurrentUser.FullName) %} &ndash; macro is a part of JS code.</p>
</li></ul>    <h3 id="src-68881114_Macrosandsecurity-Writingcustommacromethods" class="heading "><span>Writing custom macro methods</span></h3>
<p   
>When creating a <a   href="k11/Registering-custom-macro-methods.htm">custom macro method</a>, you need to ensure security yourself. The macro engine cannot predict which data is accessed in the method, and thus cannot properly secure the method.</p>
    <h3 id="src-68881114_Macrosandsecurity-Unsafemacros" class="heading "><span>Unsafe macros</span></h3>
<p   
>Query macros, cookie macros and data macros (information from the database, e.g. user display name) and their equivalent properties can be potentially dangerous. When you use these macros, you have to secure them against SQL injection and XSS.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>It is NOT possible to gain access to user passwords using macros.</p>
        </div>
    </div>
        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
