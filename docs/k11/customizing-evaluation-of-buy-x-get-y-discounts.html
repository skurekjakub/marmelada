<!DOCTYPE html><html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Customizing evaluation of Buy X Get Y discounts - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script> 
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260" elementpageid="68881603">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15">
                    <input type="submit" style="display:none" tabindex="-4">
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo">
                </h1>
                <a href="Kentico-11-Documentation-Home.html" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=68881603"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico-11-Documentation-Home.html">Kentico 11 Documentation</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="E-commerce-features.html">E-commerce features</a></li>
                                                                                                         <li class="shortcut"><a href="Customizing-and-developing-your-store.html">Customizing and developing your store</a></li>
                                                                                     <li><a href="Customizing-discounts.html">Customizing discounts</a></li>
                                                            </ul>
</div>            <h1 id="src-68881603"> <span>Customizing evaluation of Buy X Get Y discounts</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
    <div class="sp-grid-section"><div class="sp-grid-cell sp-grid-60"><div class="sp-grid-section"></div></div><div class="sp-grid-cell sp-grid-60"><div class="confbox admonition admonition-warning">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p>This page is out of date and hidden via restrictions. We've decided not to rewrite this page after the E-commerce refactoring in version 11. General BXGY customizations are covered in <a href="customizing-discounts">Customizing discounts</a>.</p>
<p>If there is demand for BXGY customization details of this type, we can rewrite and recover this page. If that happens, remember to add a version link for the <strong class=" ">bxgy_evaluation_customizing</strong> identifier in the DevNet help service.</p>
        </div>
    </div><p>If you want to modify the way <a href="working-with-buy-x-get-y-discounts">Buy X Get Y discounts</a> evaluate whether the content of the shopping cart is eligible for a Buy X Get Y discount, you need to override the <strong class=" ">GetMultiBuyDiscountsEvaluatorInternal</strong> method in <a href="e-commerce-customization-model">the <strong class=" ">MultiBuyDiscountInfoProvider</strong> class</a> of the <strong class=" ">CMS.Ecommerce</strong> namespace.</p><div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="comments">/// Returns an instance of the MultiBuyDiscountsEvaluator class that determines whether the shopping cart</code></div>
<div class="line"><code class="comments">/// is eligible for Buy X Get Y discounts on the site of the shopping cart.</code></div>
<div class="line"><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="comments">/// &lt;param name="cart"&gt;The shopping cart which is to be evaluated.&lt;/param&gt;</code></div>
<div class="line"><code class="keyword">protected</code><code class="plain"> virtual MultiBuyDiscountsEvaluator GetMultiBuyDiscountsEvaluatorInternal(ShoppingCartInfo cart)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">new</code><code class="plain"> MultiBuyDiscountsEvaluator(cart.CartProducts);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div><p>Since the <strong class=" ">GetMultiBuyDiscountsEvaluatorInternal</strong> method returns a <strong class=" ">MultiBuyDiscountsEvaluator</strong> object, you need to create your own class that inherits from the <strong class=" ">MultiBuyDiscountsEvaluator</strong> class.</p><h3 $stringutils.tolowercase(${idattribute})="" class="heading "><span>How it works by default</span></h3><p>When the system needs to evaluate whether the specific shopping cart contains products eligible for a Buy X Get Y discount, the system initializes the <strong class=" ">MultiBuyDiscountsEvaluator</strong> class and assigns a <strong class=" ">MultiBuyDiscountsApplicator</strong> object to the <strong class=" ">Applicator</strong> property.</p><ul class=" "><li class=" "><p>The <strong class=" ">EvaluateDiscounts</strong> method loops through all applicable Buy X Get Y discounts on the current site (i.e., discounts that are enabled on the current site in the time of evaluation for the given user role and whether the coupon was entered) and tries to apply the discount on the content of the shopping cart. Through the loop, if the system finds out that a discount forbids lower priority discounts to be applied, the system stops the loop.</p>
<ul class=" "><li class=" "><p>While the method is trying to apply the discount on shopping cart items, the <strong class=" ">PrepareItemsForDiscount</strong> sorts the <strong class=" ">SortedItems</strong> list (which is sorted according to the price of the items) to the <strong class=" ">PrioritizedItems</strong> list according to the priority set by the discount (the discounted items from the "get" conditions are first in the list). The prioritization works as set by the <strong class=" ">PrioritizeItems</strong> method which is located in the class of the Buy X Get Y discount, originally in the <strong class=" ">IMultiBuyDiscount</strong> interface.</p>
</li><li class=" "><p>The process of trying to apply the discount occurs in the <strong class=" ">TryApplyDiscount</strong> method. The method loops through all shopping cart items where it evaluates whether it is usable for the currently looped discount. The method also creates a list that records units of items that are used either for the "buy" conditions of the discount or the "get" conditions (either items required for the discount to be applied or items that are discounted).</p>
<ul class=" "><li class=" "><p>The process of evaluating of the discount applicability occurs in the <strong class=" ">FindDiscountApplication</strong> method. It finds out whether the shopping cart contains any item that is in the "buy" or "get" conditions of the Buy X Get Y discount. It also checks whether a product should be autoadded to the shopping cart (the <strong class=" ">AcceptMissedDiscount</strong> method of the applicator).</p>
<ul class=" "><li class=" "><p>The process of finding out whether the shopping cart contains any item in the "buy" conditions occurs in the <strong class=" ">FindItemsToBaseDiscountOn</strong> method. The method finds out the items with the lowest priority that fulfill the "buy" conditions and records how many units of the item was used for the discount.</p>
<ul class=" "><li class=" "><p>The process of checking whether the item is required for the discount occurs in the <strong class=" ">CanBaseDiscountOn</strong> method. The method checks whether there is any item not used for the "buy" or "get" conditions. The method also checks whether the discount requires the item for being applied (the <strong class=" ">IsBasedOn</strong> method of the discount object).</p>
</li><li class=" "><p>The process of creating a record of how many units of the specific item was used occurs in the <strong class=" ">AddItemsCount</strong> method.</p>
</li></ul></li><li class=" "><p>The process of finding out whether the shopping cart contains any item in the "get" conditions occurs in the <strong class=" ">FindItemsToBeDiscounted</strong> method. The method finds out the items with the highest priority that fulfill the "get" conditions and record how man units of the item was used for the discount.</p>
<ul class=" "><li class=" "><p>The process of checking whether the item is to be discounted occurs in the <strong class=" ">CanBeDiscounted</strong> method. The method checks whether there is any item not used for the "buy" or "get" conditions. The method also checks whether the discount permits to apply the discount to the item (the <strong class=" ">IsApplicableOn</strong> method of the discount object).</p>
</li><li class=" "><p>The process of creating a record of how man units of the specific item was discounted occurs in the <strong class=" ">AddItemsCount</strong> method.</p>
</li></ul></li></ul></li><li class=" "><p>The process of applying the discount occurs in the <strong class=" ">ApplyDiscount</strong> method. The method loops through all discounted items and calls the applicator of the discount to apply the discount.</p>
</li><li class=" "><p>The process of creating a record of which shopping cart was used and how many units were used occurs in the <strong class=" ">RememberUsedItems</strong> method. The method loops through all the items used for the discount (both for the "buy" conditions and the "get" conditions) and records it.</p>
</li></ul></li></ul></li></ul><div class="sp-grid-section"></div><div class="sp-grid-section"></div></div><div class="sp-grid-cell sp-grid-40 sp-grid-sidebar"><div class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-howitworksbydefault">How it works by default</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-sourcecode">Source code</a></p>
</li></ul></li><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-creatingacustomevaluatingprocessofbuyxgetydiscounts">Creating a custom evaluating process of Buy X Get Y discounts</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-customizingthemultibuydiscountinfoproviderclass">Customizing the MultiBuyDiscountInfoProvider class</a></p>
</li><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-customizingthemultibuydiscountsevaluatorclass">Customizing the MultiBuyDiscountsEvaluator class</a></p>
</li></ul></li></ul><p></p>
        </div>
    </div><div class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p><a href="customizing-application-of-buy-x-get-y-discounts">Customizing application of Buy X Get Y discounts</a></p>
</li><li class=" "><p><a href="working-with-buy-x-get-y-discounts">Working with Buy X Get Y discounts</a></p>
</li><li class=" "><p><a href="discounts">Discounts</a></p>
</li><li class=" "><p><a href="e-commerce-customization-model">E-commerce customization model</a></p>
</li><li class=" "><p><a href="customizing-providers">Customizing providers</a></p>
</li></ul>        </div>
    </div></div><div class="sp-grid-cell sp-grid-40 sp-grid-sidebar"><div class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-howitworksbydefault">How it works by default</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-sourcecode">Source code</a></p>
</li></ul></li><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-creatingacustomevaluatingprocessofbuyxgetydiscounts">Creating a custom evaluating process of Buy X Get Y discounts</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-customizingthemultibuydiscountinfoproviderclass">Customizing the MultiBuyDiscountInfoProvider class</a></p>
</li><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-customizingthemultibuydiscountsevaluatorclass">Customizing the MultiBuyDiscountsEvaluator class</a></p>
</li></ul></li></ul><p></p>
        </div>
    </div><div class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p><a href="customizing-application-of-buy-x-get-y-discounts">Customizing application of Buy X Get Y discounts</a></p>
</li><li class=" "><p><a href="working-with-buy-x-get-y-discounts">Working with Buy X Get Y discounts</a></p>
</li><li class=" "><p><a href="discounts">Discounts</a></p>
</li><li class=" "><p><a href="e-commerce-customization-model">E-commerce customization model</a></p>
</li><li class=" "><p><a href="customizing-providers">Customizing providers</a></p>
</li></ul>        </div>
    </div></div></div><div class="sp-grid-section"></div>

    

    

    
    
    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Source code</span></h4>
    <div class="scroll-expand-container collapsed">
        <div class="scroll-expand-control">
            <span class="scroll-expand-control-icon">&nbsp;</span>
            <span class="scroll-expand-control-text">See the whole source code of the class...</span>
        </div>
        <div class="scroll-expand-content">
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">using System.Collections.Generic;</code></div>
<div class="line"><code class="plain">using System.Linq;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">namespace CMS.Ecommerce</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// The class handling evaluating Buy X Get Y discounts on a set of shopping cart items.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> MultiBuyDiscountsEvaluator</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        #region </code><code class="string">"Variables"</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> List&lt;ShoppingCartItemInfo&gt; mSortedItems;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> readonly List&lt;ShoppingCartItemInfo&gt; mOriginalItems;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> readonly Dictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; mUsedDiscountItems = </code><code class="keyword">new</code><code class="plain"> Dictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt;();</code></div>
<div class="line"><code class="plain">        #endregion</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        #region </code><code class="string">"Properties"</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// List of the shopping cart items sorted by priority given by the discount.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// The discounted items from the "get" conditions are at the beginning of the list.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> List&lt;ShoppingCartItemInfo&gt; PrioritizedItems</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            get;</code></div>
<div class="line"><code class="plain">            set;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// List of the shopping cart items sorted by their price.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> IEnumerable&lt;ShoppingCartItemInfo&gt; SortedItems</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            get</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Check whether the sorted list already exists.</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> (mSortedItems == </code><code class="keyword">null</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                {</code></div>
<div class="line"><code class="plain">                    </code><code class="comments">// If the list does not exist, create a new list and sort it from the cheapest to the most expensive.</code></div>
<div class="line"><code class="plain">                    mSortedItems = </code><code class="keyword">new</code><code class="plain"> List&lt;ShoppingCartItemInfo&gt;(mOriginalItems);</code></div>
<div class="line"><code class="plain">                    mSortedItems.Sort(CompareByUnitPriceWithOptions);</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Return the sorted list.</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">return</code><code class="plain"> mSortedItems;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Dictionary containing the number of units of shopping cart items used for the discount (for both "buy" and "get" conditions).</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> Dictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; UsedDiscountItems</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            get</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">return</code><code class="plain"> mUsedDiscountItems;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Buy X Get Y discounts applicator which is used for the actual application of the discount.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">public</code><code class="plain"> IMultiBuyDiscountsApplicator Applicator</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            get;</code></div>
<div class="line"><code class="plain">            set;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        #endregion</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        #region </code><code class="string">"Constructor"</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Creates a new instance of the evaluator for the given shopping cart items.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="cartItems"&gt;Shopping cart items to be evaluated.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">public</code><code class="plain"> MultiBuyDiscountsEvaluator(IEnumerable&lt;ShoppingCartItemInfo&gt; cartItems)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            mOriginalItems = cartItems.ToList();</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        #endregion</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        #region </code><code class="string">"Discount evaluation"</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Resets the evaluator to its initial state.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual </code><code class="keyword">void</code><code class="plain"> Reset()</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Reset the applicator.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (Applicator != </code><code class="keyword">null</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                Applicator.Reset();</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Resets the number of units of the items used for the discount.</code></div>
<div class="line"><code class="plain">            mOriginalItems.ForEach(item =&gt; UsedDiscountItems.Add(item, </code><code class="value">0</code><code class="plain">));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Evaluates the given Buy X Get Y discounts and applies the matching discounts to the corresponding shopping cart items.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discounts"&gt;Buy X Get Y discounts to be evaluated.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> EvaluateDiscounts(IEnumerable&lt;IMultiBuyDiscount&gt; discounts)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Reset the evaluator to its initial state.</code></div>
<div class="line"><code class="plain">            Reset();</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Loop through all Buy X Get Y discounts to check the eligibility.</code></div>
<div class="line"><code class="plain">            foreach (var discount in discounts)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Initialize the discount for application.</code></div>
<div class="line"><code class="plain">                discount.Init();</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Prepare the shopping cart item list for discount application.</code></div>
<div class="line"><code class="plain">                PrepareItemsForDiscount(discount);</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Try to apply the discount on the shopping cart items.</code></div>
<div class="line"><code class="plain">                var applied = TryApplyDiscount(discount);</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Stop processing when the discount already applied and does not allow processing further Buy X Get Y discounts.</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> (applied &amp;&amp; !discount.ApplyFurtherDiscounts)</code></div>
<div class="line"><code class="plain">                {</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">break</code><code class="plain">;</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Ensures that the shopping cart items from the sorted list are prioritized according to the given Buy X Get Y discount.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount which prioritizes the sorted shopping cart items.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual </code><code class="keyword">void</code><code class="plain"> PrepareItemsForDiscount(IMultiBuyDiscount discount)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Create a new list from the list sorted by the price.</code></div>
<div class="line"><code class="plain">            PrioritizedItems = </code><code class="keyword">new</code><code class="plain"> List&lt;ShoppingCartItemInfo&gt;(SortedItems);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Prioritize the items according to the given discount.</code></div>
<div class="line"><code class="plain">            discount.PrioritizeItems(PrioritizedItems);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Evaluates all shopping cart items whether they are eligible for the given Buy X Get Y discount</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// and tries to apply the discount on the valid items.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount that evaluates the shopping cart items.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;Returns true it the discount was applied at least once.&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> bool TryApplyDiscount(IMultiBuyDiscount discount)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            var applied = </code><code class="keyword">false</code><code class="plain">;</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Create a new clear dictionary for items that are in the "get" conditions (discounted items).</code></div>
<div class="line"><code class="plain">            var itemsToBeDiscounted = </code><code class="keyword">new</code><code class="plain"> Dictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt;();</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Create a new clear dictionary for items that are in the "buy" conditions (items required by the discount). </code></div>
<div class="line"><code class="plain">            var itemsToBaseDiscountOn = </code><code class="keyword">new</code><code class="plain"> Dictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt;();</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Loop while the discount is allowed to be applied more times.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">do</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Clear the dictionaries.</code></div>
<div class="line"><code class="plain">                itemsToBeDiscounted.Clear();</code></div>
<div class="line"><code class="plain">                itemsToBaseDiscountOn.Clear();</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Find discount application possibility.</code></div>
<div class="line"><code class="plain">                var isApplicable = FindDiscountApplication(discount, itemsToBaseDiscountOn, itemsToBeDiscounted);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Stop the evaluation if the discount is not applicable.</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> (!isApplicable)</code></div>
<div class="line"><code class="plain">                {</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">break</code><code class="plain">;</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Mark the discounted items.</code></div>
<div class="line"><code class="plain">                ApplyDiscount(discount, itemsToBeDiscounted);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Remember the used items.</code></div>
<div class="line"><code class="plain">                RememberUsedItems(itemsToBaseDiscountOn, itemsToBeDiscounted);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Set a flag indicating application of the given discount.</code></div>
<div class="line"><code class="plain">                applied = </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            } </code><code class="keyword">while</code><code class="plain"> (discount.AllowsMoreUses());</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Return true if the discount was applied at least once.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> applied;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        #region </code><code class="string">"Searching for the items needed for the discount application"</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Finds a possibility to apply the given discount by checking whether there are the required items in the shopping cart.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount which is tried to be applied.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="itemsToBaseDiscountOn"&gt;Empty dictionary where the key is the shopping cart item and the value is</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// the number of units calculated for the discount. Found required items for the given discount are added here.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="itemsToBeDiscounted"&gt;Empty dictionary where the key is the shopping cart item and the value is</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// the number of units to be discounted. Found items discounted by the given discount are added here.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;Returns true if the given discount is applicable.&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> bool FindDiscountApplication(IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; itemsToBaseDiscountOn, IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; itemsToBeDiscounted)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Check whether the shopping cart contains items required by the given Buy X Get Y discount.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (!FindItemsToBaseDiscountOn(discount, itemsToBaseDiscountOn))</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">false</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Check whether the shopping cart contains at least one item that can be discounted.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (FindItemsToBeDiscounted(discount, itemsToBaseDiscountOn, itemsToBeDiscounted))</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Check by the applicator if a product should be autoadded.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (Applicator != </code><code class="keyword">null</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">return</code><code class="plain"> Applicator.AcceptsMissedDiscount(discount);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">false</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Finds items required by "buy" conditions of the given Buy X Get Y discount.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount with the specified required items.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="itemsToBaseDiscountOn"&gt;Empty dictionary. Found items are placed here with their counts.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;Returns true if the found items fully satisfy discount requirement "buy" conditions.&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual bool FindItemsToBaseDiscountOn(IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; itemsToBaseDiscountOn)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Get the number of products needed to enable the given discount.</code></div>
<div class="line"><code class="plain">            var minDiscountingCount = discount.BasedOnUnitsCount;</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Check whether enough items are found to apply the discount.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> (var i = </code><code class="value">0</code><code class="plain">; i &lt; minDiscountingCount; i++)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Find the item with the lowest priority which satisfies the "buy" conditions.</code></div>
<div class="line"><code class="plain">                var discounting = PrioritizedItems.LastOrDefault(item =&gt; CanBaseDiscountOn(item, discount, itemsToBaseDiscountOn));</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Check whether there is no more items left to fulfill the "buy" conditions.</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> (discounting == </code><code class="keyword">null</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                {</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">false</code><code class="plain">;</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Add 1 to the count of the specific discounting item.</code></div>
<div class="line"><code class="plain">                AddItemsCount(itemsToBaseDiscountOn, discounting, </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Finds items to be discounted with the given discount based on the given items.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount with the specific "get" conditions.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="itemsToBaseDiscountOn"&gt;Shopping cart items used for requirement "buy" conditions.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="itemsToBeDiscounted"&gt;Shopping cart items found to be discounted by this discount.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;Returns true when at least one discounted item was found.&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual bool FindItemsToBeDiscounted(IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; itemsToBaseDiscountOn, IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; itemsToBeDiscounted)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Get the number of discounted units.</code></div>
<div class="line"><code class="plain">            var maxDiscountedCount = discount.ApplyOnUnitsCount;</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Check which items are to be discounted.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">for</code><code class="plain"> (var i = </code><code class="value">0</code><code class="plain">; i &lt; maxDiscountedCount; i++)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Find the item with the highest priority which can be discounted.</code></div>
<div class="line"><code class="plain">                var discounted = PrioritizedItems.FirstOrDefault(item =&gt; CanBeDiscounted(item, discount, itemsToBaseDiscountOn, itemsToBeDiscounted));</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Check whether no more items can be discounted.</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">if</code><code class="plain"> (discounted == </code><code class="keyword">null</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                {</code></div>
<div class="line"><code class="plain">                    </code><code class="keyword">return</code><code class="plain"> i &gt; </code><code class="value">0</code><code class="plain">;</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Add 1 to the count of the specific discounted item.</code></div>
<div class="line"><code class="plain">                AddItemsCount(itemsToBeDiscounted, discounted, </code><code class="value">1</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">true</code><code class="plain">;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Checks if the given item can be discounted using the given discount.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="item"&gt;Discounted item to be checked.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount, which discounts the item, to be checked.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="basedOnItems"&gt;Shopping cart items with the count of the items found as</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// the satisfying items for the given discount.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="alreadyDiscountedItems"&gt;Shopping cart items with the count of items already</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// found as suitable for applying the discount for the given discount.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;Returns true if the given discount is applicable on the given items.&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual bool CanBeDiscounted(ShoppingCartItemInfo item, IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; basedOnItems, IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; alreadyDiscountedItems)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Get the count of the items used for "buy" conditions of the Buy X Get Y discount.</code></div>
<div class="line"><code class="plain">            var alreadyUsedUnits = GetItemsCount(basedOnItems, item);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Get the count of the already discounted items.</code></div>
<div class="line"><code class="plain">            var alreadyDiscountedUnits = GetItemsCount(alreadyDiscountedItems, item);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Check whether the shopping cart contains more unused and not free units of items then the units of items</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// used for "buy" conditions and the already discounted products. (Only paid items having some unit</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// not used for "buy" conditions can be used.)</code></div>
<div class="line"><code class="plain">            var availableUnits = GetUnusedNonFreeUnits(item) - item.CartItemAutoAddedUnits;</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (!discount.AutoAddEnabled)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                availableUnits -= item.CartItemAutoAddedUnits;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">            var hasEnoughUnits = (availableUnits - alreadyUsedUnits - alreadyDiscountedUnits &gt; </code><code class="value">0</code><code class="plain">);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Return true if the shopping cart contains enough units and the discount is applicable, i.e.,</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// affects the price of the given shopping cart item.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> hasEnoughUnits &amp;&amp; discount.IsApplicableOn(item);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Checks if the given item can be used to fulfill discount "buy" conditions.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="item"&gt;Item to be checked.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount to be checked.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="alreadyBasedOnItems"&gt;Items with the count of the item units already found as fulfilling</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// the requirements of the "buy" conditions of the given discount.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;Returns true if the shopping cart contains enough units for the discount.&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual bool CanBaseDiscountOn(ShoppingCartItemInfo item, IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; alreadyBasedOnItems)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Get the count of the items used for the "get" conditions of the discount.</code></div>
<div class="line"><code class="plain">            var alreadyUsedUnits = GetItemsCount(alreadyBasedOnItems, item);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Check whether the shopping cart contains more unused and not free units of items then</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// units of items used for "get" conditions. (Only paid items having some unit not used</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// for "get" conditions can be used.)</code></div>
<div class="line"><code class="plain">            var hasEnoughUnits = (GetUnusedNonFreeUnits(item) - alreadyUsedUnits &gt; </code><code class="value">0</code><code class="plain">);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Return true if the shopping cart contains enough units and the discount.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> hasEnoughUnits &amp;&amp; discount.IsBasedOn(item);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        #endregion</code></div>
<div class="line"><code class="plain">        #endregion</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        #region </code><code class="string">"Discount application"</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Applies the Buy X Get Y discount on the given number of units of the given shopping cart item.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount which is applied.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="itemsToBeDiscounted"&gt;Dictionary containing the items as the keys</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// and the count of the discounted units as the values.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> ApplyDiscount(IMultiBuyDiscount discount, IEnumerable&lt;KeyValuePair&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt;&gt; itemsToBeDiscounted)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Loop through all discounted items.</code></div>
<div class="line"><code class="plain">            foreach (var itemCount in itemsToBeDiscounted)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                var item = itemCount.Key;</code></div>
<div class="line"><code class="plain">                var count = itemCount.Value;</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Apply the discount on the specific item.</code></div>
<div class="line"><code class="plain">                ApplyDiscount(discount, item, count);</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Set that the discount was applied.</code></div>
<div class="line"><code class="plain">                discount.AcceptApplication(item, count);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Applies the Buy X Get Y discount to the given number of units of the given shopping cart item.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discount"&gt;Discount which is applied.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="itemToBeDiscounted"&gt;Shopping cart item to apply the discount on.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="units"&gt;Number of units to be discounted.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual </code><code class="keyword">void</code><code class="plain"> ApplyDiscount(IMultiBuyDiscount discount, ShoppingCartItemInfo itemToBeDiscounted, </code><code class="keyword">int</code><code class="plain"> units)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (Applicator != </code><code class="keyword">null</code><code class="plain">)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Apply the discount on the specific item with the applicator.</code></div>
<div class="line"><code class="plain">                Applicator.ApplyDiscount(discount, itemToBeDiscounted, units);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        #endregion</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        #region </code><code class="string">"Management of items already used for a discount."</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Makes a record that the given items in the given number of units were used for the given discount.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discountingItemsCounts"&gt;Shopping cart items used for the requirement "buy" conditions.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// The value is the number of units used for discount.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="discountedItemsCounts"&gt;Shopping cart items used for the "get" conditions (the discounted items).</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// The value is the number of units used for discount.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual </code><code class="keyword">void</code><code class="plain"> RememberUsedItems(IEnumerable&lt;KeyValuePair&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt;&gt; discountingItemsCounts, IEnumerable&lt;KeyValuePair&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt;&gt; discountedItemsCounts)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Loop through all the shopping cart items used for the requirement "buy" conditions.</code></div>
<div class="line"><code class="plain">            foreach (var item in discountingItemsCounts)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Add the used units of the item to the count of all used item units.</code></div>
<div class="line"><code class="plain">                UsedDiscountItems[item.Key] += item.Value;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Loop through all the shopping cart items used for the "get" conditions (the discounted items).</code></div>
<div class="line"><code class="plain">            foreach (var item in discountedItemsCounts)</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                </code><code class="comments">// Add the used units of the item to the count of all used item units.</code></div>
<div class="line"><code class="plain">                UsedDiscountItems[item.Key] += item.Value;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Returns the number of units not used for any discount (neither as the requirement "buy" conditions</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// items nor as the "get" conditions items - the discounted items).</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="item"&gt;Item to get number of units for.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;Returns the number of units not used for any discount.&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">protected</code><code class="plain"> virtual </code><code class="keyword">int</code><code class="plain"> GetUnusedNonFreeUnits(ShoppingCartItemInfo item)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> item.CartItemUnits - UsedDiscountItems[item];</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        #endregion</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        #region </code><code class="string">"Helper methods"</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Gets the unit count of the given shopping cart item.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="items"&gt;Dictionary of shopping cart items. The key is the shopping cart item object,</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// the value is number of units of the item.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="item"&gt;Shopping cart item with the desired number of units.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;The unit count of the given shopping cart item (if exists; otherwise, it returns 0).&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">int</code><code class="plain"> GetItemsCount(IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; items, ShoppingCartItemInfo item)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            var units = </code><code class="value">0</code><code class="plain">;</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (items.ContainsKey(item))</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                units = items[item];</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> units;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Adds the number of units to the specified shopping cart item in the list of shopping cart items.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="items"&gt;Dictionary of shopping cart items. The key is the shopping cart item object,</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// the value is number of units of the item.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="item"&gt;Shopping cart item to which the units are to be added.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="units"&gt;Number of units to be added to the specified shopping cart item.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> AddItemsCount(IDictionary&lt;ShoppingCartItemInfo, </code><code class="keyword">int</code><code class="plain">&gt; items, ShoppingCartItemInfo item, </code><code class="keyword">int</code><code class="plain"> units)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (!items.ContainsKey(item))</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                items.Add(item, </code><code class="value">0</code><code class="plain">);</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="plain">            items[item] += units;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// Computes the difference between two prices. By default, it uses the unit price.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// If the unit price is not available, the method uses the shopping cart item price.</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="item1"&gt;Dictionary of shopping cart items. The key is the shopping cart item object,</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// the value is number of units of the item.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;param name="item2"&gt;Shopping cart item with the desired number of units.&lt;/param&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">/// &lt;returns&gt;The unit count of the given shopping cart item (if exists; otherwise, it returns 0).&lt;/returns&gt;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">int</code><code class="plain"> CompareByUnitPriceWithOptions(ShoppingCartItemInfo item1, ShoppingCartItemInfo item2)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// For both prices, if the price is not unexpected value, use the unit price.</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Otherwise, use shopping cart item price.</code></div>
<div class="line"><code class="plain">			var price1 = item1.CartItemPrice ?? item1.UnitPrice;</code></div>
<div class="line"><code class="plain">            var price2 = item2.CartItemPrice ?? item2.UnitPrice;</code></div>
<div class="line"><code class="plain">  </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Return a number indicating the relative difference between the two prices.</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">return</code><code class="plain"> price1.CompareTo(price2);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">        #endregion</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
        </div>
    </div>
    <h3 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Creating a custom evaluating process of Buy X Get Y discounts</span></h3>
<p>To customize the Buy X Get Y discount evaluation:</p>
<ol class=" "><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-customizingthemultibuydiscountinfoproviderclass">Override the <strong class=" ">CMS.Ecommerce.MultiBuyDiscountInfoProvider.GetMultiBuyDiscountsEvaluatorInternal</strong> method.</a></p>
</li><li class=" "><p><a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-customizingthemultibuydiscountsevaluatorclass">Implement a class which inherits from the <strong class=" ">MultiBuyDiscountsEvaluator</strong> class.</a></p>
</li></ol>    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Customizing the MultiBuyDiscountInfoProvider class</span></h4>
<p>Override the <strong class=" ">GetMultiBuyDiscountsEvaluatorInternal</strong> virtual method to be able to integrate your custom <strong class=" ">MultiBuyDiscountsEvaluator</strong> class.</p>
<ol class=" "><li class=" "><p>Create a new class file in your project in Visual Studio, for example <strong class=" ">CustomMultiBuyInfoProvider</strong><strong class=" ">.cs</strong> that inherits from the <strong class=" ">MultiBuyDiscountInfoProvider</strong> class.</p>
</li><li class=" "><p>Add the <strong class=" ">CMS</strong> and <strong class=" ">CMS.Ecommerce</strong> namespaces to the <i class=" ">using</i> block.</p>
</li><li class=" "><p>Register the new InfoProvider class:</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">[assembly: RegisterCustomProvider(typeof(CustomMultiBuyInfoProvider))]</code></div>
</div>
    </div>
</li><li class=" "><p>Override the <strong class=" ">GetMultiBuyDiscountsEvaluatorInternal </strong>method with your custom (not yet existing) <strong class=" ">MultiBuyDiscountsEvaluator</strong> class:</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomMultiBuyInfoProvider : MultiBuyDiscountInfoProvider</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">protected</code><code class="plain"> override MultiBuyDiscountsEvaluator GetMultiBuyDiscountsEvaluatorInternal(ShoppingCartInfo cart)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">new</code><code class="plain"> CustomMultiBuyEvaluator(cart.CartProducts);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p><img class="confluence-embedded-image confluence-content-image-border" src="images/download/attachments/68881603/creating_custommultibuyinfoprovider_class.png" alt="images/download/attachments/68881603/creating_custommultibuyinfoprovider_class.png" width="500">
        <br><span class="caption">Creating the CustomMultiBuyInfoProvider class</span>
    </p>
</li></ol><p>The system now returns yet non-existing <strong class=" ">CustomMultiBuyEvaluator</strong> when evaluating Buy X Get Y discounts. Continue with the next steps to achieve the desired functionality.</p>
    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Customizing the MultiBuyDiscountsEvaluator class</span></h4>
<p>Implement a class inheriting from the <strong class=" ">MultiBuyDiscountsEvaluator</strong> class to provide your custom logic of evaluating Buy X Get Y discounts.</p>
<ol class=" "><li class=" "><p>Create a new class file in your project in Visual Studio, for example <strong class=" ">CustomMultiBuyEvaluator.cs</strong> that inherits from the <strong class=" ">MultiBuyDiscountsEvaluator</strong> class.</p>
</li><li class=" "><p>Add the <strong class=" ">CMS</strong> and <strong class=" ">CMS.Ecommerce</strong> namespaces to the <i class=" ">using</i> block.</p>
</li><li class=" "><p>Assign the inheritance from the <strong class=" ">MultiBuyDiscountsEvaluator</strong> class to the <strong class=" ">CustomMultiBuyEvaluator</strong> class:</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomMultiBuyEvaluator : MultiBuyDiscountsEvaluator</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p>Create a suitable constructor. The constructor of the <strong class=" ">MultiBuyDiscountsEvaluator</strong> class needs the <i class=" ">IEnumerable&lt;ShoppingCartItemInfo</i> object. For example:</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> CustomMultiBuyEvaluator(IEnumerable&lt;ShoppingCartItemInfo&gt; cartItems)</code></div>
<div class="line"><code class="plain">    : base(cartItems)</code></div>
<div class="line"><code class="plain">{ }</code></div>
</div>
    </div>
<p><img class="confluence-embedded-image confluence-content-image-border" src="images/download/attachments/68881603/creating_custommultibuyevaluator_class.png" alt="images/download/attachments/68881603/creating_custommultibuyevaluator_class.png" width="500">
    </p>
</li><li class=" "><p>Override the methods you want to change. The <strong class=" ">MultiBuyDiscountsEvaluator</strong> class contains the following virtual methods:</p>
<ul class=" "><li class=" "><p><strong class=" ">protected virtual void Reset()</strong>  Resets the evaluator to its initial state.</p>
</li><li class=" "><p><strong class=" ">protected virtual void PrepareItemsForDiscount(IMultiBuyDiscount discount)</strong>  Ensures that the shopping cart items from the <strong class=" ">SortedItems</strong> sorted list are prioritized according to the given Buy X Get Y discount.</p>
<ul class=" "><li class=" "><p><i class=" ">IMultiBuyDiscount discount</i>  Discount which prioritizes the sorted shopping cart items.</p>
</li></ul></li><li class=" "><p><strong class=" ">protected virtual bool FindItemsToBaseDiscountOn(IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, int&gt; itemsToBaseDiscountOn) </strong> Finds items required by "buy" conditions of the given Buy X Get Y discount. Returns true if the found items fully satisfy discount requirement "buy" conditions.</p>
<ul class=" "><li class=" "><p><i class=" ">IMultiBuyDiscount discount</i>  Discount with the specified required items.</p>
</li><li class=" "><p><i class=" ">IDictionary&lt;ShoppingCartItemInfo, int&gt; itemsToBaseDiscountOn</i>  Empty dictionary. Found items are placed here with their counts.</p>
</li></ul></li><li class=" "><p><strong class=" ">protected virtual bool FindItemsToBeDiscounted(IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, int&gt; itemsToBaseDiscountOn, IDictionary&lt;ShoppingCartItemInfo, int&gt; itemsToBeDiscounted) </strong> Finds items to be discounted with the given discount based on the given items. Returns true when at least one discounted item was found.</p>
<ul class=" "><li class=" "><p><i class=" ">IMultiBuyDiscount discount</i>  Discount with the specific "get" conditions.</p>
</li><li class=" "><p><i class=" ">IDictionary&lt;ShoppingCartItemInfo, int&gt; itemsToBaseDiscountOn</i>  Shopping cart items used for requirement "buy" conditions.</p>
</li><li class=" "><p><i class=" ">IDictionary&lt;ShoppingCartItemInfo, int&gt; itemsToBeDiscounted</i>  Shopping cart items found to be discounted by this discount.</p>
</li></ul></li><li class=" "><p><strong class=" ">protected virtual bool CanBeDiscounted(ShoppingCartItemInfo item, IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, int&gt; basedOnItems, IDictionary&lt;ShoppingCartItemInfo, int&gt; alreadyDiscountedItems) </strong> Checks if the given item can be discounted using the given discount. Returns true if the given discount is applicable on the given items.</p>
<ul class=" "><li class=" "><p><i class=" ">ShoppingCartItemInfo item</i>  Discounted item to be checked.</p>
</li><li class=" "><p><i class=" ">IMultiBuyDiscount discount</i>  Discount, which discounts the item, to be checked.</p>
</li><li class=" "><p><i class=" ">IDictionary&lt;ShoppingCartItemInfo, int&gt; basedOnItems</i>  Shopping cart items with the count of the items found as the satisfying items for the given discount.</p>
</li><li class=" "><p><i class=" ">IDictionary&lt;ShoppingCartItemInfo, int&gt; alreadyDiscountedItems</i>  Shopping cart items with the count of items already found as suitable for applying the discount for the given discount.</p>
</li></ul></li><li class=" "><p><strong class=" ">protected virtual bool CanBaseDiscountOn(ShoppingCartItemInfo item, IMultiBuyDiscount discount, IDictionary&lt;ShoppingCartItemInfo, int&gt; alreadyBasedOnItems) </strong> Checks if the given item can be used to fulfill discount "buy" conditions. Returns true if the shopping cart contains enough units for the discount.</p>
<ul class=" "><li class=" "><p><i class=" ">ShoppingCartItemInfo item</i>  Item to be checked.</p>
</li><li class=" "><p><i class=" ">IMultiBuyDiscount discount</i>  Discount to be checked.</p>
</li><li class=" "><p><i class=" ">IDictionary&lt;ShoppingCartItemInfo, int&gt; alreadyBasedOnItems</i>  Items with the count of the item units already found as fulfilling the requirements of the "buy" conditions of the given discount.</p>
</li></ul></li><li class=" "><p><strong class=" ">protected virtual void ApplyDiscount(IMultiBuyDiscount discount, ShoppingCartItemInfo itemToBeDiscounted, int units) </strong> Applies the Buy X Get Y discount to the given number of units of the given shopping cart item.</p>
<ul class=" "><li class=" "><p><i class=" ">IMultiBuyDiscount discount</i>  Discount which is applied.</p>
</li><li class=" "><p><i class=" ">ShoppingCartItemInfo itemToBeDiscounted</i>  Shopping cart item to apply the discount on.</p>
</li><li class=" "><p><i class=" ">int units</i>  Number of units to be discounted.</p>
</li></ul></li><li class=" "><p><strong class=" ">protected virtual void RememberUsedItems(IEnumerable&lt;KeyValuePair&lt;ShoppingCartItemInfo, int&gt;&gt; discountingItemsCounts, IEnumerable&lt;KeyValuePair&lt;ShoppingCartItemInfo, int&gt;&gt; discountedItemsCounts) </strong> Makes a record that the given items in the given number of units were used for the given discount.</p>
<ul class=" "><li class=" "><p><i class=" ">IEnumerable&lt;KeyValuePair&lt;ShoppingCartItemInfo, int&gt;&gt; discountingItemsCounts</i>  Shopping cart items used for the requirement "buy" conditions. The value is the number of units used for discount.</p>
</li><li class=" "><p><i class=" ">IEnumerable&lt;KeyValuePair&lt;ShoppingCartItemInfo, int&gt;&gt; discountedItemsCounts</i>  Shopping cart items used for the "get" conditions (the discounted items). The value is the number of units used for discount.</p>
</li></ul></li><li class=" "><p><strong class=" ">protected virtual int GetUnusedNonFreeUnits(ShoppingCartItemInfo item)</strong>  Returns the number of units not used for any discount (neither as the requirement "buy" conditions items nor as the "get" conditions items  the discounted items).</p>
<ul class=" "><li class=" "><p><i class=" ">ShoppingCartItemInfo item</i>  Item to get number of units for.</p>
</li></ul></li></ul>    <div class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p>See the complete default source code <a href="#src-68881603_customizingevaluationofbuyxgetydiscounts-sourcecode">above</a>.</p>
        </div>
    </div>
</li></ol><p>The Buy X Get Y discounts are now evaluated according to your changes.</p>
        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>


</body></html>