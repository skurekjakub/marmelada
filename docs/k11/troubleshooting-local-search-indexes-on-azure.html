<!DOCTYPE html><html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Troubleshooting local search indexes on Azure - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script> 
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260" elementpageid="68881699">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15">
                    <input type="submit" style="display:none" tabindex="-4">
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo">
                </h1>
                <a href="Kentico-11-Documentation-Home.html" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=68881699"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico-11-Documentation-Home.html">Kentico 11 Documentation</a></li>
                                                                                     <li><a href="Running-Kentico-on-Microsoft-Azure.html">Running Kentico on Microsoft Azure</a></li>
                                                            </ul>
</div>            <h1 id="src-68881699"> <span>Troubleshooting local search indexes on Azure</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
<div class="sp-grid-section"><div class="sp-grid-cell sp-grid-60"><p>This page describes how to troubleshoot issues related to <a href="using-locally-stored-search-indexes">locally stored smart search indexes</a> when running the Kentico application on Azure. Please note that each section applies either to Web Apps, Cloud Services, or both.</p><h3 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Search indexes are not being rebuilt or there are hanging tasks in the system</span></h3><p>If your local search <strong class=" ">indexes are not being built</strong> correctly or if many indexing <strong class=" ">tasks are stuck</strong> in the system, there is probably a conflict between the search index files located in the application's file system and files located on the blob storage. When an application is mapped to the blob storage, files in the file system cannot be modified. Therefore, the system is not able to delete the old search indexes.</p><p>Please proceed to the section which corresponds to your Azure environment.</p><h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Cloud Services - removing search index files</span></h4><p>Applies to: <span class="status blue ">CLOUD SERVICES</span>
</p><h5 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Quick fix</span></h5><p>The solution for this issue on Cloud Services is to delete all files in the <strong class=" "><i class=" ">~/App_Data/CMSModules/SmartSearch</i></strong> folder. Connect to your service through remote desktop and delete the files remotely in the file system.</p><h5 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Prevention</span></h5><p>Delete the files in the <i class=" ">~/App_Data/CMSModules/SmartSearch</i> folder and redeploy the cloud service. Also delete the files every time before you deploy your application to Cloud Services.</p><h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Web Apps - removing search index files</span></h4><p>Applies to: <span class="status green ">WEB APPS</span>
</p><h5 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Quick fix</span></h5><p>The immediate solution on Web Apps is to delete all files in the <strong class=" "><i class=" ">~/App_Data/CMSModules/SmartSearch</i></strong> folder. You can connect to your Web Apps service through FTP and delete the files in the file system.</p><h5 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Prevention</span></h5><p>When running Kentico on Azure Web Apps, you do not need to map the application's entire file system to the blob storage (this is optional). We recommend mapping only your media library folders to the blob storage and leaving all other files in the file system of the application.</p><p>To map only the media library folder to the blob storage, see <a href="configuring-azure-storage">Configuring Kentico to store only media files on Azure storage</a>.</p><p>However, if you want to connect the blob storage using the <strong class=" ">CMSExternalStorageName</strong> web.config key, which maps the whole file system of the application to the blob storage:</p><ul class=" "><li class=" "><p>You need to delete all search index files in the application's file system.</p>
</li></ul><div class="sp-grid-section"></div></div><div class="sp-grid-cell sp-grid-40 sp-grid-sidebar"><div class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-searchindexesarenotbeingrebuiltortherearehangingtasksinthesystem">Search indexes are not being rebuilt or there are hanging tasks in the system</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-cloudservices-removingsearchindexfiles">Cloud Services - removing search index files</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-quickfix">Quick fix</a></p>
</li><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-prevention">Prevention</a></p>
</li></ul></li><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-webapps-removingsearchindexfiles">Web Apps - removing search index files</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-quickfix.1">Quick fix</a></p>
</li><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-prevention.1">Prevention</a></p>
</li></ul></li></ul></li><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-deleting.lockfiles">Deleting .lock files</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-quickfix.2">Quick fix</a></p>
</li><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-explanation">Explanation</a></p>
</li><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-prevention.2">Prevention</a></p>
</li></ul></li><li class=" "><p><a href="#src-68881699_troubleshootinglocalsearchindexesonazure-smartsearchworkerroletroubleshootingoncloudservices">SmartSearchWorker role troubleshooting on Cloud Services</a></p>
</li></ul><p></p>
        </div>
    </div></div></div>
    


    

    

    

    

    

    



    
    <h3 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Deleting .lock files</span></h3>
<p>Applies to: <span class="status green ">WEB APPS</span>
 <span class="status blue ">CLOUD SERVICES</span>
</p>
    <h5 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Quick fix</span></h5>
<p>If the search functionality is not working properly, you can try deleting files with the <strong class=" ">.lock</strong> extension on the blob storage.     <span style="color: #262524;">
Connect to your blob storage (for example through <a class="external-link" href="http://www.cloudberrylab.com/free-microsoft-azure-explorer.aspx">Cloudberry for Azure</a>) and manually delete them.    </span>
</p>
    <h5 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Explanation</span></h5>
<p>A blob storage is shared between all instances of Kentico. If your Azure environment (Cloud Services or Web Apps) operates in multiple instances, it is important to prevent collisions. Therefore, to prevent multiple instances from manipulating the same index at the same time and ensure exclusive write operations, Kentico uses<strong class=" "> locking</strong>. Every time the smart search needs to manipulate a search index, it creates a special file with the <strong class=" ">.lock</strong> extension. This file indicates that a search indexer is working with the index. When the work is done, the system deletes the file from the storage.</p>
<p>There are two different lock files in the blob storage:</p>
<ul class=" "><li class=" "><p><strong class=" ">searchtaskindexer.lock</strong> – located in the<i class=" "> ~/App_Data/CMSModules/SmartSearch</i> directory.</p>
</li><li class=" "><p><strong class=" ">write.lock</strong> – located in the directory of specific search indexes.</p>
</li></ul><p>In some cases, these lock files may not get deleted. This may happen when the process working with the search index ends unexpectedly. When this happens, processing of indexing tasks for locally stored indexes becomes stuck. The solution is to manually delete the lock files.</p>
    <h5 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Prevention</span></h5>
<p>    <span style="color: #262524;">
On Azure Web Apps, this problem can occur again if you store the search indexes on the blob storage. We recommend that you either:    </span>
</p>
<ul class=" "><li class=" "><p>    <span style="color: #262524;">
<a href="increasing-storage-capacity-on-azure-web-apps#src-68881681_increasingstoragecapacityonazurewebapps-storingonlyspecificmedialibrariesonazureblobstorage">Map only media library folders to the blob storage</a> and leave all other files in the file system of the application.<br>– OR –<br>    </span>
</p>
</li><li class=" "><p>    <span style="color: #262524;">
<a href="increasing-storage-capacity-on-azure-web-apps#src-68881681_increasingstoragecapacityonazurewebapps-storingallfilesonazureblobstorage">Configure the scheduler to process the search tasks</a>.<br>    </span>
</p>
</li></ul>    <h3 $stringutils.tolowercase(${idattribute})="" class="heading "><span>SmartSearchWorker role troubleshooting on Cloud Services</span></h3>
<p>Applies to: <span class="status blue ">CLOUD SERVICES</span>
</p>
<p>The SmartSearchWorker role is part of the Kentico Azure project designed to be used on Azure Cloud Services. If you are not running the Cloud Services or not using the SmartSearchWorker role, this section does not apply to your environment.</p>
<p>When you are convinced that every setting and every configuration is correct and the worker role is running correctly, but still not processing the search tasks, you can look for an error in the <a href="working-with-the-system-event-log">Event log</a>.</p>
<p>    <span style="color: #262524;">
If you do not find anything related in the event log, try the following troubleshooting practice:    </span>
</p>
<ol class=" "><li class=" "><p><a class="external-link" href="https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-role-enable-remote-desktop-new-portal">Enable remote desktop for the worker role</a>.</p>
</li><li class=" "><p>Connect to the worker role through the remote desktop access.</p>
<ol class=" "><li class=" "><p>Switch to the <strong class=" ">Roles and Instances</strong> tab.</p>
</li><li class=" "><p>Select the worker role instance.</p>
</li><li class=" "><p>Click <strong class=" ">Connect</strong>.</p>
</li></ol></li><li class=" "><p>Look into the Smart search log in <i class=" ">App_Data/CMSModules/SmartSearch/workerlog.txt.</i></p>
</li><li class=" "><p>Look into the Windows event log using <strong class=" ">Event viewer</strong>. Try looking for errors from around the time the worker role was starting.</p>
</li></ol><p>Next steps can differ based on the error you find. But the error should provide you with enough information to start with.</p>
        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>


</body></html>