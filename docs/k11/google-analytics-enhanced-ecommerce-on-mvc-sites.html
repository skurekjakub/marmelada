<!DOCTYPE html><html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Google Analytics Enhanced Ecommerce on MVC sites - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script> 
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260" elementpageid="76845511">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15">
                    <input type="submit" style="display:none" tabindex="-4">
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo">
                </h1>
                <a href="Kentico-11-Documentation-Home.html" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=76845511"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico-11-Documentation-Home.html">Kentico 11 Documentation</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="Developing-websites.html">Developing websites</a></li>
                                                                                                         <li class="shortcut"><a href="Developing-sites-using-ASP.NET-MVC.html">Developing sites using ASP.NET MVC</a></li>
                                                                                     <li><a href="Developing-on-line-stores-in-MVC.html">Developing on-line stores in MVC</a></li>
                                                            </ul>
</div>            <h1 id="src-76845511"> <span>Google Analytics Enhanced Ecommerce on MVC sites</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
<div class="sp-grid-section"><div class="sp-grid-cell sp-grid-60"><div class="sp-grid-section"></div></div><div class="sp-grid-cell sp-grid-60"><p>By using the Google Analytics Enhanced Ecommerce features, you can measure and analyze shopping activity on your website (product impressions, purchases, etc.). Kentico provides an API that helps get the data of products and purchases in a format suitable for logging via Google Analytics.</p><p>Visit the <a class="external-link" href="http://www.google.com/analytics">Google Analytics website</a> to set up a Google Analytics account for the website that you wish to monitor.</p><div class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p><strong class=" ">Portal engine websites</strong></p>
<p>The information on this page applies to e-commerce sites developed using ASP.NET MVC.</p>
<p>If you are developing your on-line store using the <a href="developing-websites-using-the-portal-engine">portal engine</a>, see: <a href="integrating-google-analytics-enhanced-ecommerce">Integrating Google Analytics Enhanced Ecommerce</a></p>
        </div>
    </div><h3 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Adding Google Tag Manager</span></h3><p>Before you can start measuring e-commerce activities, you need to add Google Tag Manager to the pages of your website. Copy the snippets from the <a class="external-link" href="https://developers.google.com/tag-manager/quickstart">Google Tag Manager Quick Start Guide</a> into the appropriate sections of your MVC website's main layout (view).</p><p>You can then start collecting your site's e-commerce data and tracking events using Google Analytics. See the sections below for more information about setting up individual types of tracking.</p><div class="sp-grid-section"></div><div class="sp-grid-section"></div></div><div class="sp-grid-cell sp-grid-40 sp-grid-sidebar"><div class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-addinggoogletagmanager">Adding Google Tag Manager</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-collectinge-commercedata">Collecting e-commerce data</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-productimpressions">Product impressions</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-productclicks">Product clicks</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-viewsofproductdetails">Views of product details</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-additionsandremovalsfromashoppingcart">Additions and removals from a shopping cart</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-checkoutsteps">Checkout steps</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-purchases">Purchases</a></p>
</li></ul></li></ul><p></p>
        </div>
    </div><div class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p><a href="customizing-e-commerce-data-for-google-analytics">Customizing e-commerce data for Google Analytics</a></p>
</li></ul>        </div>
    </div></div><div class="sp-grid-cell sp-grid-40 sp-grid-sidebar"><div class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-addinggoogletagmanager">Adding Google Tag Manager</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-collectinge-commercedata">Collecting e-commerce data</a></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-productimpressions">Product impressions</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-productclicks">Product clicks</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-viewsofproductdetails">Views of product details</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-additionsandremovalsfromashoppingcart">Additions and removals from a shopping cart</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-checkoutsteps">Checkout steps</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-purchases">Purchases</a></p>
</li></ul></li></ul><p></p>
        </div>
    </div><div class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p><a href="customizing-e-commerce-data-for-google-analytics">Customizing e-commerce data for Google Analytics</a></p>
</li></ul>        </div>
    </div></div></div><div class="sp-grid-section"></div>

    
    


    
    
    <h3 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Collecting e-commerce data</span></h3>
<p>We recommend using a <a class="external-link" href="https://developers.google.com/tag-manager/devguide">data layer</a> to collect and send data to Google Analytics. For detailed information, see the <a class="external-link" href="https://developers.google.com/tag-manager/enhanced-ecommerce">Enhanced Ecommerce (UA) Developer Guide</a>.</p>
<p>The Kentico API provides methods that allow you to get suitable JSON data for <a href="products">product</a> and <a href="orders">order</a> objects, which you can push into the data layer. The following helper classes are available in the <strong class=" ">CMS.Ecommerce</strong> namespace of the standard Kentico API (provided by the <i class=" ">Kentico.Libraries</i> integration package).</p>
<p><strong class=" ">GtmProductHelper</strong> class:</p>
<ul class=" "><li class=" "><p><strong class=" ">MapSku</strong> – returns a <i class=" ">GtmData</i> object containing the data of a specified product (<i class=" ">SkuInfo</i> object). Provides the following data fields by default: <i class=" ">id</i> (the product's <i class=" ">SKU</i> value), <i class=" ">name</i>, <i class=" ">price</i> and <i class=" ">brand</i></p>
</li><li class=" "><p><strong class=" ">MapShoppingCartItems</strong> – returns an <i class=" ">IEnumerable&lt;GtmData&gt;</i> collection containing the data of specified products in a shopping cart (<i class=" ">IEnumerable&lt;ShoppingCartItemInfo&gt;</i> collection). By default, provides the same data fields as the <i class=" ">MapSku</i> method and also adds the unit <i class=" ">quantity</i> for each product.</p>
</li></ul><p><strong class=" ">GtmOrderHelper</strong> class:</p>
<ul class=" "><li class=" "><p><strong class=" ">MapPurchase</strong> – returns a <i class=" ">GtmData</i> object containing the overall purchase data for a specified order (<i class=" ">OrderInfo</i> object). Provides the following data by default:</p>
<ul class=" "><li class=" "><p><i class=" ">actionField</i> object representing the overall purchase, with the following fields:</p>
<ul class=" "><li class=" "><p><i class=" ">id</i> (the integer ID of the Kentico order object)</p>
</li><li class=" "><p><i class=" ">revenue</i> (the order's <i class=" ">GrandTotal</i> value, i.e. the final price including discounts, shipping, tax, and reductions from applied <a href="working-with-gift-cards">gift cards</a>)</p>
</li><li class=" "><p><i class=" ">shipping</i></p>
</li><li class=" "><p><i class=" ">tax</i></p>
</li></ul></li><li class=" "><p><i class=" ">products</i> object containing all products within the order (the product data format is the same as provided by the <i class=" ">GtmProductHelper.MapShoppingCartItems</i> method)</p>
</li></ul></li><li class=" "><p><strong class=" ">MapOrder</strong> – returns a <i class=" ">GtmData</i> object containing a summary of the specified order (<i class=" ">OrderInfo</i> object). Provides the data fields described for the <i class=" ">actionField</i> object within the data returned by the <i class=" ">MapPurchase</i> method.</p>
</li><li class=" "><p><strong class=" ">MapOrderItems</strong> – returns an <i class=" ">IEnumerable&lt;GtmData&gt;</i> collection containing the data of all products within the specified order (<i class=" ">OrderInfo</i> object). Provides the same data as the <i class=" ">products</i> object within the data returned by the <i class=" ">MapPurchase</i> method.</p>
</li></ul><p><strong class=" ">GtmDataHelper</strong> class:</p>
<ul class=" "><li class=" "><p><strong class=" ">SerializeToJson</strong> – serializes the <i class=" ">GtmData</i> objects returned by the <i class=" ">GtmProductHelper</i> or <i class=" ">GtmOrderHelper</i> methods into JSON strings. Provides one overload for individual objects (<i class=" ">GtmData</i> parameter) and another for collections of objects (<i class=" ">IEnumerable&lt;GtmData&gt;</i> parameter).</p>
</li></ul>    <div class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p><strong class=" ">Adding custom data</strong></p>
<p>When calling the methods of the <i class=" ">GtmProductHelper</i> and <i class=" ">GtmOrderHelper</i> classes, you can add custom data fields via the optional <strong class=" ">additionalData</strong> parameter. The methods merge the fields and values of the custom object into the returned <i class=" ">GtmData</i> objects.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Example</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Example" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">GtmProductHelper.MapSKU(sku, </code><code class="keyword">new</code><code class="plain"> { category = </code><code class="string">"Apparel"</code><code class="plain"> })</code></div>
</div>
    </div>
        </div>
    </div>
<p>Use the listed methods to create a Google Analytics implementation that suits the purposes of your website. Alternatively, you can compose the required JSON data manually using your own custom code. The following sections contain best practices for various types of e-commerce tracking on Kentico MVC sites:</p>
<p></p>
<ul class="toc-indentation "><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-productimpressions">Product impressions</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-productclicks">Product clicks</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-viewsofproductdetails">Views of product details</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-additionsandremovalsfromashoppingcart">Additions and removals from a shopping cart</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-checkoutsteps">Checkout steps</a></p>
</li><li class=" "><p><a href="#src-76845511_googleanalyticsenhancedecommerceonmvcsites-purchases">Purchases</a></p>
</li></ul><p></p>
    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Product impressions</span></h4>
<p>To log impressions of products displayed to visitors (for example on <a href="displaying-product-listings-on-mvc-sites">product listing pages</a>):</p>
<ol class=" "><li class=" "><p>Set up a view model class representing individual items in the product list:<br></p>
<ol class=" "><li class=" "><p>Add a property of the <i class=" ">GtmData</i> type, which will store the product's Google Analytics data.</p>
</li><li class=" "><p>Get the product's data by calling the <strong class=" ">GtmProductHelper.MapSKU</strong> method, and assign it to the new property.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> Kentico.Ecommerce;</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> ProductListItemViewModel</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">readonly</code><code class="plain"> GtmData GtmSKUJson;</code></div>
<div class="line"><code class="plain">	...</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Constructor of the view model class representing items in product lists</code></div>
<div class="line"><code class="plain">	</code><code class="keyword">public</code><code class="plain"> ProductListItemViewModel(SKUTreeNode productPage, ProductPrice priceDetail, </code><code class="keyword">string</code><code class="plain"> publicStatusName)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Creates the Google Tag Manager data for the given product and assigns it to a property</code></div>
<div class="line"><code class="plain">        GtmSKUJson = GtmProductHelper.MapSKU(productPage.SKU);</code></div>
<div class="line"><code class="plain">        ...</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ol></li><li class=" "><p>Set up another view model class representing the overall product list:</p>
<ol class=" "><li class=" "><p>Add a property storing a collection of the listed products (represented by your list item view model class).</p>
</li><li class=" "><p>Add a <i class=" ">string</i> property, which will store the JSON data of all listed products.</p>
</li><li class=" "><p>Create the product list JSON string by calling the <strong class=" ">GtmDataHelper.SerializeToJson</strong> method. Prepare an <i class=" ">IEnumerable</i> collection containing the <i class=" ">GtmData</i> values of individual products as the method's parameter. Assign the resulting string into the new property.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> System.Collections.Generic;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> System.Linq;</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> ProductListViewModel</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> IEnumerable&lt;ProductListItemViewModel&gt; Products;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">readonly</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> GtmProductsJsonString;</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Constructor of the view model class representing the overall product list</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> ProductListViewModel(IEnumerable&lt;ProductListItemViewModel&gt; products)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        Products = products;</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Creates the Google Tag Manager JSON data for the product list and assigns it to a property</code></div>
<div class="line"><code class="plain">        GtmProductsJsonString = GtmDataHelper.SerializeToJson(Products.Select(product =&gt; product.GtmSKUJson));</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ol></li><li class=" "><p>Adjust your controller actions that display products to work with the view models. For example:</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> ActionResult Index()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Gets products of the product page type (via the generated page type code)</code></div>
<div class="line"><code class="plain">    List&lt;LearningProductType&gt; products = LearningProductTypeProvider.GetLearningProductTypes()</code></div>
<div class="line"><code class="plain">        .LatestVersion(</code><code class="keyword">false</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        .Published(</code><code class="keyword">true</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        .OnSite(siteName)</code></div>
<div class="line"><code class="plain">        .Culture(</code><code class="string">"en-US"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        .CombineWithDefaultCulture()</code></div>
<div class="line"><code class="plain">        .WhereTrue(</code><code class="string">"SKUEnabled"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        .OrderByDescending(</code><code class="string">"SKUInStoreFrom"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        .ToList();</code></div>
<div class="line"><code class="plain">            </code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Prepares the view model for the listing page</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">var</code><code class="plain"> model = </code><code class="keyword">new</code><code class="plain"> ProductListViewModel(products.Select(</code></div>
<div class="line"><code class="plain">        product =&gt; </code><code class="keyword">new</code><code class="plain"> ProductListItemViewModel(</code></div>
<div class="line"><code class="plain">            product,</code></div>
<div class="line"><code class="plain">            pricingService.CalculatePrice(product.SKU, shoppingService.GetCurrentShoppingCart()),</code></div>
<div class="line"><code class="plain">            product.Product.PublicStatus?.PublicStatusDisplayName))</code></div>
<div class="line"><code class="plain">        );</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Displays the action's view with an initialized view model</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> View(model);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p>Edit the view representing your product list pages.</p>
</li><li class=" "><p>Run a script that pushes the JSON data from the product listing view model into the data layer.</p>
<ul class=" "><li class=" "><p>You can either add a script tag directly into the view code or link an external JavaScript file.</p>
</li><li class=" "><p>Process the JSON string to ensure that the output is not HTML encoded (for example by calling the <a class="external-link" href="https://msdn.microsoft.com/en-us/library/gg480740(v=vs.118).aspx">HtmlHelper.Raw</a> method).</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">document.addEventListener(</code><code class="string">"DOMContentLoaded"</code><code class="plain">, function (</code><code class="keyword">event</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">    dataLayer.push({</code></div>
<div class="line"><code class="plain">        </code><code class="string">"ecommerce"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">            </code><code class="string">"impressions"</code><code class="plain">: @Html.Raw(Model.GtmProductsJsonString)</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
    </div>
</li></ul></li></ol>    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Product clicks</span></h4>
<p>To log clicks of product links:</p>
<ol class=" "><li class=" "><p>Edit the view model class that you use to display product links (for example on <a href="displaying-product-listings-on-mvc-sites">product listing pages</a>):<br></p>
<ol class=" "><li class=" "><p>Add a <i class=" ">string</i> property, which will store the JSON data of the given product.</p>
</li><li class=" "><p>Create a JSON string containing the product's data by calling the <strong class=" ">GtmProductHelper.MapSKU</strong> and <strong class=" ">GtmDataHelper.SerializeToJson</strong> methods, and assign the string to the new property.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> Kentico.Ecommerce;</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> ProductListItemViewModel</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">readonly</code><code class="plain"> GtmData GtmSKUJson;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">readonly</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> GtmSKUJsonString;</code></div>
<div class="line"><code class="plain">    ...</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Constructor of the view model class representing items in product lists</code></div>
<div class="line"><code class="plain">	</code><code class="keyword">public</code><code class="plain"> ProductListItemViewModel(SKUTreeNode productPage, ProductPrice priceDetail, </code><code class="keyword">string</code><code class="plain"> publicStatusName)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Creates the Google Tag Manager data for the given product</code></div>
<div class="line"><code class="plain">        GtmSKUJson = GtmProductHelper.MapSKU(productPage.SKU);</code></div>
<div class="line"><code class="plain">        GtmSKUJsonString = GtmDataHelper.SerializeToJson(GtmSKUJson);</code></div>
<div class="line"><code class="plain">        ...</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ol></li><li class=" "><p>Define a JavaScript function for the pages containing product links (for example by adding a script tag to the corresponding views or by linking an external JavaScript file).</p>
<ul class=" "><li class=" "><p>Within the function, push the data of the clicked product into the data layer. The function must have parameters containing the product JSON data and the URL of the clicked link.</p>
</li><li class=" "><p>Use the <i class=" ">eventCallback</i> datalayer variable to perform redirection after the product data is sent to Google Analytics.<br></p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Function example</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Function example" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">function</code><code class="plain"> productClick(productJson, link) {</code></div>
<div class="line"><code class="plain">    dataLayer.push({</code></div>
<div class="line"><code class="plain">        </code><code class="string">"event"</code><code class="plain">: </code><code class="string">"productClick"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"ecommerce"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">            </code><code class="string">"click"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">                </code><code class="string">"actionField"</code><code class="plain">: {</code><code class="string">"list"</code><code class="plain"> : </code><code class="string">"Search Results"</code><code class="plain">},</code></div>
<div class="line"><code class="plain">                </code><code class="string">"products"</code><code class="plain">: [productJson]</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        },</code></div>
<div class="line"><code class="plain">        </code><code class="string">"eventCallback"</code><code class="plain">: </code><code class="keyword">function</code><code class="plain"> () {</code></div>
<div class="line"><code class="plain">            document.location.href = link;</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ul></li><li class=" "><p>Add an <strong class=" ">onclick</strong> script to your product links and call the defined product click function.</p>
<ul class=" "><li class=" "><p>Get the JSON data of the clicked product from the view model.</p>
</li><li class=" "><p>Process the JSON string to ensure that the output is not HTML encoded (for example by calling the <a class="external-link" href="https://msdn.microsoft.com/en-us/library/gg480740(v=vs.118).aspx">HtmlHelper.Raw</a> method).</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">View example</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="View example" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">@model ProductListViewModel</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">@</code><code class="keyword">foreach</code><code class="plain"> (ProductListItemViewModel product </code><code class="keyword">in</code><code class="plain"> Model.Products)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    @* Creates a hyperlink to the product controller to display the product detail page *@</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">string</code><code class="plain"> productDetailLink = Url.RouteUrl(</code><code class="string">"Product"</code><code class="plain">, </code><code class="keyword">new</code><code class="plain"> { id = product.ProductPageID, productAlias = product.ProductPageAlias });</code></div>
<div class="line"><code class="plain">    &lt;a href=</code><code class="string">"@productDetailLink"</code><code class="plain"> onclick=</code><code class="string">'productClick(@Html.Raw(product.GtmSKUJsonString), "@productDetailLink"); return false;'</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">    ...</code></div>
<div class="line"><code class="plain">    &lt;/a&gt;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ul></li></ol>    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Views of product details</span></h4>
<p>To log data when visitors view your website's <a href="displaying-product-details-on-mvc-sites">product detail pages</a>:</p>
<ol class=" "><li class=" "><p>Edit the view model class that you use to display product details.</p>
</li><li class=" "><p>Add a new <i class=" ">string</i> property to the view model.</p>
</li><li class=" "><p>Create a JSON string containing the product's data by calling the <strong class=" ">GtmProductHelper.MapSKU</strong> and <strong class=" ">GtmDataHelper.SerializeToJson</strong> methods, and assign the string to the new property.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> Kentico.Ecommerce;</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> ProductViewModel</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">readonly</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> GtmSKUJsonString;</code></div>
<div class="line"><code class="plain">	...</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Constructor of the view model class used to display product details</code></div>
<div class="line"><code class="plain">	</code><code class="keyword">public</code><code class="plain"> ProductViewModel(SKUTreeNode productPage, ProductPrice priceDetail)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Creates the Google Tag Manager JSON data for the given product and assigns it to a property</code></div>
<div class="line"><code class="plain">        SKUInfo sku = productPage.SKU;</code></div>
<div class="line"><code class="plain">        GtmSKUJsonString = GtmDataHelper.SerializeToJson(GtmProductHelper.MapSKU(sku));</code></div>
<div class="line"><code class="plain">        ...</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p>Edit the view representing your product detail pages.</p>
</li><li class=" "><p>Run a script that pushes the product JSON data from the view model into the data layer.</p>
<ul class=" "><li class=" "><p>You can either add a script tag directly into the view code or link an external JavaScript file.</p>
</li><li class=" "><p>Process the JSON string to ensure that the output is not HTML encoded (for example by calling the <a class="external-link" href="https://msdn.microsoft.com/en-us/library/gg480740(v=vs.118).aspx">HtmlHelper.Raw</a> method).</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">document.addEventListener(</code><code class="string">"DOMContentLoaded"</code><code class="plain">, function (</code><code class="keyword">event</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">    dataLayer.push({</code></div>
<div class="line"><code class="plain">        </code><code class="string">"ecommerce"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">            </code><code class="string">"detail"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">                </code><code class="string">"actionField"</code><code class="plain">: { </code><code class="string">"list"</code><code class="plain">: </code><code class="string">"Gallery"</code><code class="plain"> },</code></div>
<div class="line"><code class="plain">                </code><code class="string">"products"</code><code class="plain">: [@Html.Raw(Model.GtmSKUJsonString)]</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
    </div>
</li></ul></li></ol>    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Additions and removals from a shopping cart</span></h4>
<p>To log data when customers add or remove shopping cart items:</p>
    <div class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p>For more information about shopping cart management in general, see <a href="using-a-shopping-cart-on-mvc-sites">Using a shopping cart on MVC sites</a>.</p>
        </div>
    </div>
<ol class=" "><li class=" "><p>Edit the view model class that you use to display shopping cart content and add a <i class=" ">string</i> property. The property will store JSON data for added or removed products.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> ShoppingCartViewModel</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> ShoppingCart Cart { </code><code class="keyword">get</code><code class="plain">; </code><code class="keyword">set</code><code class="plain">; }</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> IEnumerable&lt;ShoppingCartItem&gt; Items =&gt; Cart.Items;        </code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">decimal</code><code class="plain"> RemainingAmountForFreeShipping { </code><code class="keyword">get</code><code class="plain">; </code><code class="keyword">set</code><code class="plain">; }</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Property containing Google Tag Manager JSON data for added or removed products</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> GtmAddOrRemoveCartItemJsonString { </code><code class="keyword">get</code><code class="plain">; </code><code class="keyword">set</code><code class="plain">; }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p>Adjust the controller actions that you use to add or remove products to/from the shopping cart:</p>
<ul class=" "><li class=" "><p>Create an object with an <a class="external-link" href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/anonymous-types">Anonymous type</a>, and define the data fields that you wish to push into the Google Analytics data layer (see the <a class="external-link" href="https://developers.google.com/tag-manager/enhanced-ecommerce#cart">Enhanced Ecommerce (UA) Developer Guide</a> for details).</p>
</li><li class=" "><p>Get the data of the added or removed product by calling the <strong class=" ">GtmProductHelper.MapSKU</strong> method. Use the method's optional <i class=" ">additionalData</i> parameter to add the quantity of the added/removed product units into the data.</p>
</li><li class=" "><p>Serialize the anonymous type object into a JSON string (for example using the <a class="external-link" href="https://msdn.microsoft.com/en-us/library/system.web.helpers.json.encode(v=vs.111).aspx">Json.Encode</a> method) and assign the string into the corresponding property of the shopping cart view model. For example, you can use the <a class="external-link" href="https://msdn.microsoft.com/en-us/library/dd394711.aspx">TempData</a> dictionary to pass the JSON string into another controller action that prepares the shopping cart view model.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Example - Action for adding items</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Example - Action for adding items" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">[HttpPost]</code></div>
<div class="line"><code class="keyword">public</code><code class="plain"> ActionResult AddItem(</code><code class="keyword">int</code><code class="plain"> itemSkuId, </code><code class="keyword">int</code><code class="plain"> itemUnits)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Gets the current user's shopping cart</code></div>
<div class="line"><code class="plain">    ShoppingCart cart = shoppingService.GetCurrentShoppingCart();</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Adds a specified number of units of a specified product</code></div>
<div class="line"><code class="plain">    cart.AddItem(itemSkuId, itemUnits);</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Evaluates the shopping cart</code></div>
<div class="line"><code class="plain">    cart.Evaluate();</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Creates an anonymous type object representing the Google Tag Manager JSON data for the product addition event</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">var</code><code class="plain"> addToCartJson = </code><code class="keyword">new</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        @</code><code class="keyword">event</code><code class="plain"> = </code><code class="string">"addToCart"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        ecommerce = </code><code class="keyword">new</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            currencyCode = cart.Currency.CurrencyCode,</code></div>
<div class="line"><code class="plain">            add = </code><code class="keyword">new</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                products = </code><code class="keyword">new</code><code class="plain">[]</code></div>
<div class="line"><code class="plain">                {</code></div>
<div class="line"><code class="plain">                    GtmProductHelper.MapSKU(SKUInfoProvider.GetSKUInfo(itemSkuId), </code><code class="keyword">new</code><code class="plain"> { quantity = itemUnits })</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    };</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Serializes the Google Tag Manager JSON data of the product addition event into a string</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Stores the string in the TempData dictionary, which is later used to prepare the shopping cart view model</code></div>
<div class="line"><code class="plain">    TempData[</code><code class="string">"gtmAddOrRemoveCartItemJsonString"</code><code class="plain">] = System.Web.Helpers.Json.Encode(addToCartJson);</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Displays the shopping cart</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> RedirectToAction(</code><code class="string">"ShoppingCart"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Example - Action for removing items</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Example - Action for removing items" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">[HttpPost]</code></div>
<div class="line"><code class="keyword">public</code><code class="plain"> ActionResult RemoveItem(</code><code class="keyword">int</code><code class="plain"> itemID)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Gets the current user's shopping cart</code></div>
<div class="line"><code class="plain">    ShoppingCart cart = shoppingService.GetCurrentShoppingCart();</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Gets the ShoppingCartItemInfo object representing the removed product</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Note: Must be performed before calling the ShoppingCart.RemoveItem method</code></div>
<div class="line"><code class="plain">    ShoppingCartItemInfo cartItem = ShoppingCartItemInfoProvider.GetShoppingCartItemInfo(itemID);</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Creates an anonymous type object representing the Google Tag Manager JSON data for the product removal event</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">var</code><code class="plain"> removeFromCartJson = </code><code class="keyword">new</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        @</code><code class="keyword">event</code><code class="plain"> = </code><code class="string">"removeFromCart"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        ecommerce = </code><code class="keyword">new</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            remove = </code><code class="keyword">new</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                products = </code><code class="keyword">new</code><code class="plain">[]</code></div>
<div class="line"><code class="plain">                {</code></div>
<div class="line"><code class="plain">                    GtmProductHelper.MapSKU(cartItem.SKU, </code><code class="keyword">new</code><code class="plain"> { quantity = cartItem.CartItemUnits })                            </code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    };</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Removes a specified product from the shopping cart</code></div>
<div class="line"><code class="plain">    cart.RemoveItem(itemID);</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Evaluates the shopping cart</code></div>
<div class="line"><code class="plain">    cart.Evaluate();</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Serializes the Google Tag Manager JSON data of the product removal event into a string</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Stores the string in the TempData dictionary, which is later used to prepare the shopping cart view model</code></div>
<div class="line"><code class="plain">    TempData[</code><code class="string">"gtmAddOrRemoveCartItemJsonString"</code><code class="plain">] = System.Web.Helpers.Json.Encode(removeFromCartJson);</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Displays the shopping cart</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> RedirectToAction(</code><code class="string">"ShoppingCart"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Example - Updated action displaying the shopping cart</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Example - Updated action displaying the shopping cart" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> ActionResult ShoppingCart()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Gets the current user's shopping cart</code></div>
<div class="line"><code class="plain">    ShoppingCart currentCart = shoppingService.GetCurrentShoppingCart();</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Initializes the shopping cart model</code></div>
<div class="line"><code class="plain">    ShoppingCartViewModel model = </code><code class="keyword">new</code><code class="plain"> ShoppingCartViewModel</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Assigns the current shopping cart to the model</code></div>
<div class="line"><code class="plain">        Cart = currentCart,</code></div>
<div class="line"><code class="plain">        RemainingAmountForFreeShipping = pricingService.CalculateRemainingAmountForFreeShipping(currentCart),</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets Google Tag Manager JSON data for product addition or removal events from the TempData dictionary</code></div>
<div class="line"><code class="plain">        GtmAddOrRemoveCartItemJsonString = TempData[</code><code class="string">"gtmAddOrRemoveCartItemJsonString"</code><code class="plain">] </code><code class="keyword">as</code><code class="plain"> </code><code class="keyword">string</code></div>
<div class="line"><code class="plain">    };</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Displays the shopping cart</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> View(model);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ul></li><li class=" "><p>Edit the view that you use to display shopping cart content.</p>
</li><li class=" "><p>Run a script that pushes the JSON string from the shopping cart view model into the data layer:</p>
<ul class=" "><li class=" "><p>You can either add a script tag directly into the view code or link an external JavaScript file.</p>
</li><li class=" "><p>Wrap the script code into a condition that checks the JSON string for null or empty values. The condition ensures that the script only runs when displaying the shopping cart after a customer adds or removes products.</p>
</li><li class=" "><p>Process the JSON string to ensure that the output is not HTML encoded (for example by calling the <a class="external-link" href="https://msdn.microsoft.com/en-us/library/gg480740(v=vs.118).aspx">HtmlHelper.Raw</a> method).</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">View example</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="View example" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">@model ShoppingCartViewModel</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">...</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">@</code><code class="keyword">if</code><code class="plain"> (!String.IsNullOrEmpty(Model.GtmAddOrRemoveCartItemJsonString))</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    &lt;script type=</code><code class="string">"text/javascript"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">        document.addEventListener(</code><code class="string">"DOMContentLoaded"</code><code class="plain">, function (</code><code class="keyword">event</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">            dataLayer.push(@Html.Raw(Model.GtmAddOrRemoveCartItemJsonString));</code></div>
<div class="line"><code class="plain">        });</code></div>
<div class="line"><code class="plain">    &lt;/script&gt;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ul></li></ol>    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Checkout steps</span></h4>
<p>To log progress of customers through the steps of your website's <a href="checkout-process-in-mvc">checkout process</a>:</p>
<ol class=" "><li class=" "><p>Identify the first page in your checkout process where modifications of the shopping cart content are no longer allowed.</p>
</li><li class=" "><p>Edit the view model class that you use for the given checkout page and add a <i class=" ">string</i> property. The property will store JSON data for the products in the shopping cart.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Example</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Example" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> DeliveryDetailsViewModel</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> CustomerModel Customer { </code><code class="keyword">get</code><code class="plain">; </code><code class="keyword">set</code><code class="plain">; }</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> BillingAddressModel BillingAddress { </code><code class="keyword">get</code><code class="plain">; </code><code class="keyword">set</code><code class="plain">; }</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> ShippingOptionModel ShippingOption { </code><code class="keyword">get</code><code class="plain">; </code><code class="keyword">set</code><code class="plain">; }</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Property containing Google Tag Manager JSON data for products in the shopping cart</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> GtmCartItemsJsonString { </code><code class="keyword">get</code><code class="plain">; </code><code class="keyword">set</code><code class="plain">; }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p>Adjust the controller actions that you use to display the given checkout page:</p>
<ul class=" "><li class=" "><p>Get the JSON data for the products in the shopping cart by calling the <strong class=" ">GtmProductHelper.MapShoppingCartItems</strong> method.</p>
</li><li class=" "><p>Serialize the shopping cart product data into a JSON string by calling the <strong class=" ">GtmDataHelper.SerializeToJson</strong> method, and assign the string into the corresponding property of the view model.</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Example - Action for displaying the delivery details page</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Example - Action for displaying the delivery details page" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">public</code><code class="plain"> ActionResult DeliveryDetails()</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Gets the current user's shopping cart</code></div>
<div class="line"><code class="plain">    ShoppingCart cart = shoppingService.GetCurrentShoppingCart();</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	...</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Creates the Google Tag Manager JSON data for the products in the shopping cart</code></div>
<div class="line"><code class="plain">    IEnumerable&lt;ShoppingCartItemInfo&gt; cartItemInfos = cart.Items.Select(item =&gt; ShoppingCartItemInfoProvider.GetShoppingCartItemInfo(item.ID));</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">string</code><code class="plain"> gtmCartItemsJsonString = GtmDataHelper.SerializeToJson(GtmProductHelper.MapShoppingCartItems(cartItemInfos));</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    DeliveryDetailsViewModel model = </code><code class="keyword">new</code><code class="plain"> DeliveryDetailsViewModel</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        Customer = </code><code class="keyword">new</code><code class="plain"> CustomerModel(cart.Customer),</code></div>
<div class="line"><code class="plain">        BillingAddress = </code><code class="keyword">new</code><code class="plain"> BillingAddressModel(cart.BillingAddress, countries, </code><code class="keyword">null</code><code class="plain">),</code></div>
<div class="line"><code class="plain">        ShippingOption = </code><code class="keyword">new</code><code class="plain"> ShippingOptionModel(cart.ShippingOption, shippingOptions),</code></div>
<div class="line"><code class="plain">        GtmCartItemsJsonString = gtmCartItemsJsonString</code></div>
<div class="line"><code class="plain">    };</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Displays the customer details step</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> View(model);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ul></li><li class=" "><p>Edit the view representing the appropriate checkout page:</p>
<ul class=" "><li class=" "><p>Run a script that pushes the required checkout data into the data layer. Get the JSON data of the shopping cart's products from the view model.</p>
</li><li class=" "><p>You can either add a script tag directly into the view code or link an external JavaScript file.</p>
</li><li class=" "><p>Process the JSON string to ensure that the output is not HTML encoded (for example by calling the <a class="external-link" href="https://msdn.microsoft.com/en-us/library/gg480740(v=vs.118).aspx">HtmlHelper.Raw</a> method).</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">document.addEventListener(</code><code class="string">"DOMContentLoaded"</code><code class="plain">, function(</code><code class="keyword">event</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">    dataLayer.push({</code></div>
<div class="line"><code class="plain">        </code><code class="string">"event"</code><code class="plain">: </code><code class="string">"checkout"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"ecommerce"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">            </code><code class="string">"checkout"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">                </code><code class="string">"actionField"</code><code class="plain">: {</code><code class="string">"step"</code><code class="plain">: 1},</code></div>
<div class="line"><code class="plain">                </code><code class="string">"products"</code><code class="plain">: @Html.Raw(Model.GtmCartItemsJsonString)</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
    </div>
</li></ul></li><li class=" "><p>Edit the views representing the pages used for the remaining steps in the checkout process.</p>
<ul class=" "><li class=" "><p>For each step, run a script that pushes the required checkout data into the data layer, but without including the <i class=" ">products</i> field. For example:</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">document.addEventListener(</code><code class="string">"DOMContentLoaded"</code><code class="plain">, function (</code><code class="keyword">event</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">    dataLayer.push({</code></div>
<div class="line"><code class="plain">        </code><code class="string">"event"</code><code class="plain">: </code><code class="string">"checkout"</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">"ecommerce"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">            </code><code class="string">"checkout"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">                </code><code class="string">"actionField"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">                    </code><code class="string">"step"</code><code class="plain">: 2,</code></div>
<div class="line"><code class="plain">                    </code><code class="string">"option"</code><code class="plain">: </code><code class="string">"@Model.Cart.ShippingOption.ShippingOptionDisplayName"</code></div>
<div class="line"><code class="plain">                }</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
    </div>
</li></ul></li></ol>    <h4 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Purchases</span></h4>
<p>To log purchases (i.e. completed <a href="orders">orders</a>) on your website:</p>
<ol class=" "><li class=" "><p>Identify the page that you display to customers after they successfully complete a purchase on your website (for example a "thank you" page).</p>
</li><li class=" "><p>Set up a view model class for this "thank you" page:</p>
<ul class=" "><li class=" "><p>Add a <i class=" ">string</i> property, which will store the JSON data for the purchase.</p>
</li><li class=" "><p>Create a JSON string containing the purchase data by calling the <strong class=" ">GtmOrderHelper.MapPurchase</strong> and <strong class=" ">GtmDataHelper.SerializeToJson</strong> methods, and assign the string to the property.</p>
    <div class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p>To get the required <i class=" ">OrderInfo</i> parameter, call the <strong class=" ">OrderInfoProvider.GetOrderInfo</strong> method (from the <i class=" ">CMS.Ecommerce</i> namespace). The internal <i class=" ">OrderInfo</i> object has the same ID as the matching <i class=" ">Kentico.Ecommerce.Order</i> object (this class is used to manage orders in the E-commerce integration API for MVC).</p>
        </div>
    </div>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> Kentico.Ecommerce;</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> ThankYouViewModel</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">readonly</code><code class="plain"> </code><code class="keyword">string</code><code class="plain"> GtmPurchaseJsonString;</code></div>
<div class="line"><code class="plain">        </code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Constructor of the view model class for the "thank you" page of the checkout process</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> ThankYouViewModel(Order order)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the internal OrderInfo object for the completed order</code></div>
<div class="line"><code class="plain">        OrderInfo orderInfo = OrderInfoProvider.GetOrderInfo(order.OrderID);</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">        </code><code class="comments">// Creates the Google Tag Manager JSON data for the purchased order</code></div>
<div class="line"><code class="plain">        GtmPurchaseJsonString = GtmDataHelper.SerializeToJson(GtmOrderHelper.MapPurchase(orderInfo));</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li></ul></li><li class=" "><p>Find an appropriate controller action to display the "thank you" view (for example an action that handles payments). Create an instance of the view model class for the related <i class=" ">Kentico.Ecommerce.Order</i> object. For more information about order processing, see <a href="creating-the-preview-step-in-mvc-checkout-processes">Creating the preview step in MVC checkout processes</a>.</p>
</li><li class=" "><p>Edit the view that you use to display the "thank you" page.</p>
</li><li class=" "><p>Run a script that pushes the purchase JSON data from the view model into the data layer:</p>
<ul class=" "><li class=" "><p>You can either add a script tag directly into the view code or link an external JavaScript file.</p>
</li><li class=" "><p>Process the JSON string to ensure that the output is not HTML encoded (for example by calling the <a class="external-link" href="https://msdn.microsoft.com/en-us/library/gg480740(v=vs.118).aspx">HtmlHelper.Raw</a> method).</p>
    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">document.addEventListener(</code><code class="string">"DOMContentLoaded"</code><code class="plain">, function(</code><code class="keyword">event</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">    dataLayer.push({</code></div>
<div class="line"><code class="plain">        </code><code class="string">"ecommerce"</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">            </code><code class="string">"purchase"</code><code class="plain">: @Html.Raw(Model.GtmPurchaseJsonString)</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
    </div>
</li></ul></li></ol>        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>


</body></html>