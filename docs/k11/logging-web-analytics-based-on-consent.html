<!DOCTYPE html><html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Logging web analytics based on consent - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script> 
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260" elementpageid="76845044">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15">
                    <input type="submit" style="display:none" tabindex="-4">
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo">
                </h1>
                <a href="Kentico-11-Documentation-Home.html" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=76845044"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico-11-Documentation-Home.html">Kentico 11 Documentation</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="Configuring-Kentico.html">Configuring Kentico</a></li>
                                                                                     <li><a href="GDPR-compliance.html">GDPR compliance</a></li>
                                                            </ul>
</div>            <h1 id="src-76845044"> <span>Logging web analytics based on consent</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
<div class="sp-grid-section"><div class="sp-grid-cell sp-grid-60"><div class="sp-grid-section"></div></div><div class="sp-grid-cell sp-grid-60"><p>By default, <a href="web-analytics">web analytics</a> log data for all visitors on the live website. Developers can customize the system to log web analytics only for visitors who give some form of consent.</p><p>The system provides the <strong class=" ">WebAnalyticsEvents.CheckAnalyticsConsent</strong> global event, which triggers before any type of web analytics are logged for visitors (before processing of visitor personal data). By <a href="handling-global-events">assigning a handler</a> to the event, developers can perform the following:</p><ul class=" "><li class=" "><p>Define a condition according to the website's consent requirements. The condition can be based on <a href="working-with-consents">consents managed within Kentico</a> or on any other data available in the context of the request.</p>
</li><li class=" "><p>Set the <strong class=" ">HasConsent</strong> property of the handler's <strong class=" ">CheckAnalyticsConsentEventArgs</strong> parameter based on the result. If the property is <i class=" ">false</i>, the system does not process web analytics for the given request.</p>
</li></ul><div class="sp-grid-section"></div><div class="sp-grid-section"></div></div><div class="sp-grid-cell sp-grid-40 sp-grid-sidebar"><div class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p><a href="web-analytics">Web analytics</a></p>
</li><li class=" "><p><a href="working-with-consents">Working with consents</a></p>
</li><li class=" "><p><a href="handling-global-events">Handling global events</a></p>
</li><li class=" "><p><a href="reference---global-system-events">Reference - Global system events</a></p>
</li></ul>        </div>
    </div></div><div class="sp-grid-cell sp-grid-40 sp-grid-sidebar"><div class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p><a href="web-analytics">Web analytics</a></p>
</li><li class=" "><p><a href="working-with-consents">Working with consents</a></p>
</li><li class=" "><p><a href="handling-global-events">Handling global events</a></p>
</li><li class=" "><p><a href="reference---global-system-events">Reference - Global system events</a></p>
</li></ul>        </div>
    </div></div></div><div class="sp-grid-section"></div>

    
    <h3 $stringutils.tolowercase(${idattribute})="" class="heading "><span>Example</span></h3>
<p>The following example demonstrates how to disable logging of web analytics for all visitors (contacts) who have not accepted a <a href="working-with-consents">consent</a> with the <i class=" ">WebAnalytics</i> code name.</p>
    <div class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p><strong class=" ">Kentico EMS required</strong></p>
<p>The example uses the <a href="working-with-contacts">contact tracking</a> and <a href="working-with-consents">consent</a> features to evaluate whether a visitor has given consent to log web analytics. As a result, it only works for sites with a <strong class=" ">Kentico EMS</strong> license.</p>
        </div>
    </div>
<ol class=" "><li class=" "><p>Open your Kentico project in Visual Studio (using the <strong class=" ">WebSite.sln</strong> or <strong class=" ">WebApp.sln</strong> file).</p>
</li><li class=" "><p>Create a <a href="initializing-modules-to-run-custom-code">custom module class</a>.</p>
<ul class=" "><li class=" "><p>We recommend adding the class into a custom <i class=" ">Class library</i> project within the Kentico solution.</p>
</li></ul></li><li class=" "><p>Override the module's <strong class=" ">OnInit</strong> method and assign a handler method to the <strong class=" ">WebAnalyticsEvents.CheckAnalyticsConsent.Execute</strong> event.</p>
</li><li class=" "><p>Perform the required actions within the handler method:<br></p>
<ul class=" "><li class=" "><p>To disable logging of web analytics for a given request, set the <strong class=" ">HasConsent</strong> property of the handler's <strong class=" ">CheckAnalyticsConsentEventArgs</strong> parameter to <i class=" ">false</i>.</p>
</li><li class=" "><p>You can evaluate whether to log web analytics based on any custom condition. Access data from request contexts or use the <strong class=" ">ContactId</strong> property of the handler's <strong class=" ">CheckAnalyticsConsentEventArgs</strong> parameter to get the ID of the contact object for which the analytics are being logged.</p>
</li></ul></li></ol>    <div class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.DataEngine;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Core;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.DataProtection;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.ContactManagement;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.WebAnalytics;</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="comments">// Registers the custom module into the system</code></div>
<div class="line"><code class="plain">[assembly: RegisterModule(</code><code class="keyword">typeof</code><code class="plain">(CustomConsentModule))]</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomConsentModule : Module</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Module class constructor, the system registers the module under the name "CustomConsent"</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> CustomConsentModule()</code></div>
<div class="line"><code class="plain">        : </code><code class="keyword">base</code><code class="plain">(</code><code class="string">"CustomConsent"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Contains initialization code that is executed when the application starts</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">protected</code><code class="plain"> </code><code class="keyword">override</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> OnInit()</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">base</code><code class="plain">.OnInit();</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">        </code><code class="comments">// Assigns a handler to the WebAnalyticsEvents.CheckAnalyticsConsent.Execute event</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// This event occurs before the system logs web analytics for visitors and processes their personal data</code></div>
<div class="line"><code class="plain">        WebAnalyticsEvents.CheckAnalyticsConsent.Execute += Analytics_CheckConsent;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">    </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> Analytics_CheckConsent(</code><code class="keyword">object</code><code class="plain"> sender, CheckAnalyticsConsentEventArgs e)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the contact for which the analytics are being logged</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Note: The contact is null for visitors who have not given consent for contact tracking</code></div>
<div class="line"><code class="plain">        ContactInfo contact = ContactInfoProvider.GetContactInfo(e.ContactId);</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the consent that will be evaluated</code></div>
<div class="line"><code class="plain">        ConsentInfo consent = ConsentInfoProvider.GetConsentInfo(</code><code class="string">"WebAnalytics"</code><code class="plain">);</code></div>
<div class="line">&nbsp;</div>
<div class="line"><code class="plain">        </code><code class="comments">// Disables web analytics logging for all visitors (contacts) who have not accepted the "WebAnalytics" consent declaration</code></div>
<div class="line"><code class="plain">        IConsentAgreementService consentService = Service.Resolve&lt;IConsentAgreementService&gt;();</code></div>
<div class="line"><code class="plain">        e.HasConsent = (contact != </code><code class="keyword">null</code><code class="plain"> &amp;&amp; consent != </code><code class="keyword">null</code><code class="plain">) &amp;&amp; consentService.IsAgreed(contact, consent);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <div class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p><strong class=" ">Performance recommendations</strong></p>
<p>The system triggers the <strong class=" ">CheckAnalyticsConsent</strong> event frequently when displaying pages to visitors (multiple times per web request in certain cases). Running demanding operations within the event's handler method may have a negative impact on your site's performance.</p>
<p>We strongly recommend caching the results of your consent conditions. To learn about the custom caching options provided by the Kentico API, see: <a href="caching-in-custom-code">Caching in custom code</a></p>
        </div>
    </div>
    <div class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p><strong class=" ">Tip – Logging analytics based on tracking consent</strong></p>
<p>For visitors who have not given consent for the tracking of contacts and activities (see <a href="working-with-consents">Working with consents</a>), the <strong class=" ">ContactId</strong> property of the handler's <strong class=" ">CheckAnalyticsConsentEventArgs</strong> parameter is 0.</p>
<p>You can use the tracking consent as your condition for logging of web analytics. In this case, you do not need to define or evaluate an additional "web analytics consent". You only need to create a condition that checks whether the <i class=" ">ContactId</i> value is greater than 0, i.e. that the web analytics are being logged for an existing contact.</p>
        </div>
    </div>
        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>


</body></html>