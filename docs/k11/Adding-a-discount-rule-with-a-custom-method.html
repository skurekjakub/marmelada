<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Adding a discount rule with a custom method - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script> 
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo" />
                </h1>
                <a href="Kentico-11-Documentation-Home.html" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=68881619"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico-11-Documentation-Home.html">Kentico 11 Documentation</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="E-commerce-features.html">E-commerce features</a></li>
                                                                                                         <li class="shortcut"><a href="Customizing-and-developing-your-store.html">Customizing and developing your store</a></li>
                                                                                     <li><a href="Configuring-discount-rules.html">Configuring discount rules</a></li>
                                                            </ul>
</div>            <h1 id="src-68881619"> <span>Adding a discount rule with a custom method</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
<p  class="confluence-link" 
>  <a   href="Working-with-catalog-discounts">Catalog discounts</a>,   <a   href="Working-with-order-discounts">order discounts</a>,   <a   href="Working-with-free-shipping-offers">free shipping offers</a> and   <a   href="Working-with-gift-cards">gift cards</a> provide the option of setting conditions, which limit how the given discount or offer is applied. The conditions can be built using a pre-defined set of rules. However, you can also add new rules so that store managers can offer discounts just as they want them. You can learn more basic information about adding new discount rules in   <a   href="Configuring-discount-rules">Configuring discount rules</a>.</p>
<p   
>This page describes how to add discount rules that use a custom macro method, which developers define in the system&#39;s code. You can then create discount rules that call the custom method, and use them in the conditions of catalog discounts, order discounts, free shipping offers or gift cards.</p>
<p   
>To create a discount rule (both order and catalog rules) that calls a custom method, you need to:</p>
    <div  class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
>  <a   href="#src-68881619_safe-id-QWRkaW5nYWRpc2NvdW50cnVsZXdpdGhhY3VzdG9tbWV0aG9kLUV4YW1wbGXigJNBZGRpbmdhcnVsZXRoYXRjaGVja3Nwcm9kdWN0Y2F0ZWdvcmllcw">Example &ndash; Adding a rule that checks product categories</a></p>
<ul class="toc-indentation "><li class=" "><p   
>  <a   href="#src-68881619_Addingadiscountrulewithacustommethod-Creatingamacromethodcontainerclass">Creating a macro method container class</a></p>
</li><li class=" "><p   
>  <a   href="#src-68881619_Addingadiscountrulewithacustommethod-Addinganorderrule">Adding an order rule</a></p>
</li></ul></li></ul><p   
></p>
        </div>
    </div>
<ol class=" "><li class=" "><p   
>Open your Kentico solution in Visual Studio.</p>
</li><li class=" "><p   
>Create a new class that inherits from the <strong class=" ">MacroMethodContainer</strong> class.</p>
    <div  class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Class location</strong></p>
<p   
>For production sites, we recommend creating a new assembly (Class library project) in your Kentico solution and including the macro container there. You need to add the appropriate references to both the assembly and the main Kentico web project. For more information, refer to   <a   href="Best-practices-for-customization">Best practices for customization</a>.</p>
        </div>
    </div>
</li><li class=" "><p   
>  <a   href="Registering-custom-macro-methods#src-68882638_Registeringcustommacromethods-Registeringmacromethodcontainers">Register the custom macro container</a> for specific data types or macro namespaces using the <strong class=" ">RegisterExtension</strong> attribute.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">For order rules</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="For order rules" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">using CMS;</code></div>
<div class="line"><code class="plain">using CMS.Ecommerce;</code></div>
<div class="line"><code class="plain">using CMS.MacroEngine;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[assembly: RegisterExtension(typeof(CustomOrderRuleMacroMethods ), typeof(CalculatorData))]</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomOrderRuleMacroMethods : MacroMethodContainer</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">For catalog rules</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="For catalog rules" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">using CMS;</code></div>
<div class="line"><code class="plain">using CMS.Ecommerce;</code></div>
<div class="line"><code class="plain">using CMS.MacroEngine;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[assembly: RegisterExtension(typeof(CustomCatalogRuleMacroMethods ), typeof(SKUInfo))]</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomCatalogRuleMacroMethods : MacroMethodContainer</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p   
>  <a   href="Registering-custom-macro-methods#src-68882638_Registeringcustommacromethods-Definingmacromethods">Define your custom macro methods</a>.</p>
</li><li class=" "><p   
>Save the files (and build your custom class library project).</p>
</li><li class=" "><p   
>Sign in to the Kentico administration interface and   <a   href="Configuring-discount-rules#src-68881610_Configuringdiscountrules-Addingdiscountrules">create a discount rule</a> using the custom macro methods.</p>
</li></ol><p   
>Your store managers can now limit discounts and offers using the added discount rule. When evaluating conditions based on the rule, the system calls the created custom macro method.</p>
    <h3 id="src-68881619_safe-id-QWRkaW5nYWRpc2NvdW50cnVsZXdpdGhhY3VzdG9tbWV0aG9kLUV4YW1wbGXigJNBZGRpbmdhcnVsZXRoYXRjaGVja3Nwcm9kdWN0Y2F0ZWdvcmllcw" class="heading "><span>Example &ndash; Adding a rule that checks product categories</span></h3>
<p   
>The following example demonstrates how to add an   <a   href="Configuring-discount-rules">order rule</a> with a macro condition that calls a custom method. The custom discount rule checks whether   <a   href="Products">products</a> in the evaluated shopping cart or order belong to a specific   <a   href="Categorizing-pages">page category</a>. You can specify a minimum number of product units that must belong to the page category to be eligible for the discount.</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Stand-alone SKUs</strong></p>
<p   
>Even though the principle is the same, this specific example does not work for   <a   href="Managing-stand-alone-SKUs">stand-alone SKUs</a>. Page categories are available only for products that combine an SKU object and a page (the default approach in Kentico).</p>
        </div>
    </div>
<p   
>To create a discount rule that checks a product&#39;s category:</p>
<ol class=" "><li class=" "><p   
>  <a   href="#src-68881619_Addingadiscountrulewithacustommethod-Creatingamacromethodcontainerclass">Create a macro method container class</a></p>
</li><li class=" "><p   
>  <a   href="#src-68881619_Addingadiscountrulewithacustommethod-Addinganorderrule">Add an order discount rule that uses the custom method from the class</a></p>
</li></ol>    <h4 id="src-68881619_Addingadiscountrulewithacustommethod-Creatingamacromethodcontainerclass" class="heading "><span>Creating a macro method container class</span></h4>
<p   
>Prepare a separate project for custom classes in your Kentico solution:</p>
<ol class=" "><li class=" "><p   
>Open your Kentico solution in Visual Studio.</p>
</li><li class=" "><p   
>Create a new <i class=" ">Class Library</i> project in the Kentico solution (or reuse an existing custom project).</p>
</li><li class=" "><p   
>Add references to the required Kentico libraries (DLLs) for the new project:<br/></p>
<ol class=" "><li class=" "><p   
>Right-click the project and select <strong class=" ">Add -&gt; Reference</strong>.</p>
</li><li class=" "><p   
>Select the <strong class=" ">Browse</strong> tab of the <strong class=" ">Reference manager</strong> dialog, click <strong class=" ">Browse</strong> and navigate to the <i class=" "><strong class=" ">Lib</strong> </i>folder of your Kentico web project.</p>
</li><li class=" "><p   
>Add references to the following libraries:</p>
<ul class=" "><li class=" "><p   
><strong class=" ">CMS.Base.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Core.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.DataEngine.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.DocumentEngine.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Ecommerce.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Helpers.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.MacroEngine.dll</strong></p>
</li></ul></li></ol></li><li class=" "><p   
>Reference the custom project from the Kentico web project <i class=" ">(CMSApp</i> or <i class=" ">CMS)</i>.</p>
</li><li class=" "><p   
>Edit the custom project&#39;s <strong class=" ">AssemblyInfo.cs</strong> file (in the <i class=" ">Properties</i> folder).</p>
</li><li class=" "><p   
>Add the <strong class=" ">AssemblyDiscoverable</strong> assembly attribute:<br/></p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[assembly:AssemblyDiscoverable]</code></div>
</div>
    </div>
</li></ol><p   
>Continue by creating the macro method container class:</p>
<ol class=" "><li class=" "><p   
>Create a new class named <strong class=" ">CustomEcommerceMacroMethods</strong> under the custom project.</p>
</li><li class=" "><p   
>Add the following code to the class:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> System;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> System.Collections.Generic;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> System.Linq;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.DocumentEngine;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Helpers;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.MacroEngine;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[assembly: RegisterExtension(</code><code class="keyword">typeof</code><code class="plain">(CustomEcommerceMacroMethods), </code><code class="keyword">typeof</code><code class="plain">(CalculatorData))]</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomEcommerceMacroMethods : MacroMethodContainer</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Returns a true value if the shopping cart / order data contains at least the specified number of product units in the specified category.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    [MacroMethod(</code><code class="keyword">typeof</code><code class="plain">(</code><code class="keyword">bool</code><code class="plain">), </code><code class="string">"Returns a true value if the shopping cart / order data contains at least the specified number of product units in the specified category."</code><code class="plain">, 3)]</code></div>
<div class="line"><code class="plain">    [MacroMethodParam(0, </code><code class="string">"data"</code><code class="plain">, </code><code class="keyword">typeof</code><code class="plain">(CalculatorData), </code><code class="string">"Shopping cart / order calculation data"</code><code class="plain">)]</code></div>
<div class="line"><code class="plain">    [MacroMethodParam(1, </code><code class="string">"categoryName"</code><code class="plain">, </code><code class="keyword">typeof</code><code class="plain">(</code><code class="keyword">string</code><code class="plain">), </code><code class="string">"The name of a page category"</code><code class="plain">)]</code></div>
<div class="line"><code class="plain">    [MacroMethodParam(2, </code><code class="string">"itemsCount"</code><code class="plain">, </code><code class="keyword">typeof</code><code class="plain">(</code><code class="keyword">int</code><code class="plain">), </code><code class="string">"The required number of product units"</code><code class="plain">)]</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">static</code><code class="plain"> </code><code class="keyword">object</code><code class="plain"> ContainsProductsInCategory(EvaluationContext context, </code><code class="keyword">params</code><code class="plain"> </code><code class="keyword">object</code><code class="plain">[] parameters)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">switch</code><code class="plain"> (parameters.Length)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">case</code><code class="plain"> 3:</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">return</code><code class="plain"> ContainsProductsInCategory(parameters);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">            </code><code class="keyword">default</code><code class="plain">:</code></div>
<div class="line"><code class="plain">                </code><code class="keyword">throw</code><code class="plain"> </code><code class="keyword">new</code><code class="plain"> NotSupportedException();</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">static</code><code class="plain"> </code><code class="keyword">bool</code><code class="plain"> ContainsProductsInCategory(</code><code class="keyword">object</code><code class="plain">[] parameters)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the shopping cart calculation data</code></div>
<div class="line"><code class="plain">        CalculatorData data = (CalculatorData)parameters[0];</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the page category that is checked</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">string</code><code class="plain"> categoryName = ValidationHelper.GetString(parameters[1], String.Empty);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the minimum required number of product units</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">int</code><code class="plain"> minItemsCount = ValidationHelper.GetInteger(parameters[2], 1);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the IDs of SKUs (products) in the shopping cart / order</code></div>
<div class="line"><code class="plain">        List&lt;</code><code class="keyword">int</code><code class="plain">&gt; itemIds = data.Request.Items</code></div>
<div class="line"><code class="plain">                                </code><code class="comments">// Filters out product options</code></div>
<div class="line"><code class="plain">                                .Where(item =&gt; !(item.SKU.IsProductOption))</code></div>
<div class="line"><code class="plain">                                </code><code class="comments">// Ensures selection of the ID for both standard products and variants</code></div>
<div class="line"><code class="plain">                                .Select&lt;CalculationRequestItem, </code><code class="keyword">int</code><code class="plain">&gt;(item =&gt; item.SKU.IsProductVariant ? item.SKU.SKUParentSKUID : item.SKU.SKUID)</code></div>
<div class="line"><code class="plain">                                .ToList();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Gets the IDs of all related product pages that belong to the specified category</code></div>
<div class="line"><code class="plain">        List&lt;TreeNode&gt; pages = DocumentHelper.GetDocuments()</code></div>
<div class="line"><code class="plain">                                .OnCurrentSite()</code></div>
<div class="line"><code class="plain">                                .InCategories(categoryName)</code></div>
<div class="line"><code class="plain">                                .WhereIn(</code><code class="string">"NodeSKUID"</code><code class="plain">, itemIds)</code></div>
<div class="line"><code class="plain">                                .Columns(</code><code class="string">"NodeSKUID"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">                                .ToList();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Counts the total number of product units that belong to the specified category</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">int</code><code class="plain"> count = 0;</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">foreach</code><code class="plain"> (CalculationRequestItem item </code><code class="keyword">in</code><code class="plain"> data.Request.Items)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Gets the ID of standard products or the main product's ID for variants</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">int</code><code class="plain"> itemId = item.SKU.IsProductVariant ? item.SKU.SKUParentSKUID : item.SKU.SKUID;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">            </code><code class="comments">// Increases the count by the number of units if the product ID matches one of the pages with the specified category</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">if</code><code class="plain"> (pages.Exists(doc =&gt; doc.NodeSKUID == itemId))</code></div>
<div class="line"><code class="plain">            {</code></div>
<div class="line"><code class="plain">                count += (</code><code class="keyword">int</code><code class="plain">)item.Quantity;</code></div>
<div class="line"><code class="plain">            }</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="comments">// Returns a true value if the count is higher than or equal to the required minimum</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> (minItemsCount &lt;= count);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p   
>Save all changes and <strong class=" ">Build</strong> the custom project.</p>
</li></ol><p   
>The system now provides the custom <strong class=" ">ContainsProductsInCategory</strong> macro method for objects of the <strong class=" ">CalculatorData</strong> type (the <i class=" ">CalculatorData</i> is available within the context of order discount rules).</p>
    <h4 id="src-68881619_Addingadiscountrulewithacustommethod-Addinganorderrule" class="heading "><span>Adding an order rule</span></h4>
<p   
>Follow the steps below to create an order discount macro rule that enables discounts for customers whose order contains at least a specified number of product units belonging to a selected page category.</p>
<ol class=" "><li class=" "><p   
>Open the <strong class=" ">Store configuration </strong>application if you want to create an order rule for the current site. Open the <strong class=" ">Multistore configuration</strong> application if you run multiple sites on the same Kentico instance and you want to add the rule for all the sites.<br/></p>
    <div  class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>If you are not sure what to choose, see   <a   href="Choosing-site-or-global-e-commerce-configuration">Choosing site or global e-commerce configuration</a>. If you are not sure about specifics of configuring in these applications, see   <a   href="Configuring-e-commerce-settings-for-a-specific-site-or-globally">Configuring e-commerce settings for a specific site or globally</a>.</p>
        </div>
    </div>
</li><li class=" "><p   
>Switch to the <strong class=" ">Discount rules -&gt; Order rules</strong> tab.</p>
</li><li class=" "><p   
>Click <strong class=" ">New order rule</strong>.</p>
<ul class=" "><li class=" "><p   
>The system opens a new page where you can specify the order rule properties and define the rule&#39;s parameters.</p>
</li></ul></li><li class=" "><p   
>Enter the following values for the rule&#39;s properties:<br/></p>
<ul class=" "><li class=" "><p   
><strong class=" ">Display name</strong>: Order contains products from a category</p>
</li><li class=" "><p   
><strong class=" ">User text</strong>: The order contains at least {number} products from the {category} category</p>
</li><li class=" "><p  class="auto-cursor-target" 
><strong class=" ">Condition</strong>: <tt class=" ">Data.ContainsProductsInCategory(&quot;{category}&quot;, {number})</tt></p>
    <div  class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Notice that the <strong class=" ">ContainsProductsInCategory</strong> macro method defined in the custom code is now used in the order rule&#39;s condition.</p>
        </div>
    </div>
</li></ul></li><li class=" "><p   
>Click <strong class=" ">Save</strong>.</p>
</li><li class=" "><p   
>Define the rule&#39;s parameters:<strong class=" "><br/></strong></p>
<ol class=" "><li class=" "><p   
>Switch to the <strong class=" ">Parameters</strong> tab.</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>You specified two parameters that modify the rule&#39;s condition (<i class=" ">number</i> and <i class=" ">category</i>). The system adds them automatically. You can now adjust the parameters&#39; settings.</p>
        </div>
    </div>
</li><li class=" "><p   
>Select <i class=" "><strong class=" ">number</strong></i> in the left panel and set the following properties:<br/></p>
<ul class=" "><li class=" "><p   
><strong class=" ">Field name</strong>: number</p>
</li><li class=" "><p   
><strong class=" ">Data type</strong>: Integer number</p>
</li><li class=" "><p   
><strong class=" ">Required</strong>: Yes (selected)</p>
</li><li class=" "><p   
><strong class=" ">Display field in the editing form</strong>: Yes (selected)<br/></p>
</li><li class=" "><p   
><strong class=" ">Field caption</strong>: select number</p>
</li><li class=" "><p   
><strong class=" ">Form control</strong>: Text box<br/></p>
<img  class="confluence-embedded-image confluence-content-image-border"  src="images/download/attachments/68881619/specifying_parameter_properties_number.png" alt="images/download/attachments/68881619/specifying_parameter_properties_number.png" width="500"  />
        <br/><span class="caption">Specifying parameter properties</span>
    </li></ul></li><li class=" "><p   
>Click <strong class=" ">Save</strong>.</p>
</li><li class=" "><p   
>Select <i class=" "><strong class=" ">category</strong></i> in the left panel and set the following properties:<br/></p>
<ul class=" "><li class=" "><p   
><strong class=" ">Field name</strong>: category</p>
</li><li class=" "><p   
><strong class=" ">Data type</strong>: Text</p>
</li><li class=" "><p   
><strong class=" ">Required</strong>: Yes (selected)</p>
</li><li class=" "><p   
><strong class=" ">Display field in the editing form</strong>: Yes (selected)</p>
</li><li class=" "><p   
><strong class=" ">Field caption</strong>: select category</p>
</li><li class=" "><p   
><strong class=" ">Form control</strong>: Category selector (select via the <i class=" ">(more items...)</i> option)</p>
</li><li class=" "><p   
><strong class=" ">Display personal categories</strong>: No (cleared)</p>
</li><li class=" "><p   
><strong class=" ">Display general categories</strong>: Yes (selected)</p>
</li></ul></li><li class=" "><p   
>Click <strong class=" ">Save</strong>.</p>
</li></ol></li></ol><p   
>The custom order rule with two parameters is now ready. You can create or edit   <a   href="Working-with-order-discounts">order discounts</a>,   <a   href="Working-with-free-shipping-offers">free shipping offers</a> and   <a   href="Working-with-gift-cards">gift cards</a> with conditions based on the new rule.</p>
        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
