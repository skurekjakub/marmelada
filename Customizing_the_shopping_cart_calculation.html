<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Customizing the shopping cart calculation - Kentico 11 Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="68879260">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">K11</span>
                    <img class="space-logo" src="global.logo" />
                </h1>
                <a href="Kentico_11_Documentation_Home.html" class="ht-space-link">
                    <h2>Kentico 11 Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=72975274"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="Kentico_11_Documentation_Home.html">Kentico 11 Documentation</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="E-commerce_features.html">E-commerce features</a></li>
                                                                                                         <li class="shortcut"><a href="Customizing_and_developing_your_store.html">Customizing and developing your store</a></li>
                                                                                     <li><a href="Shopping_cart-related_customizing.html">Shopping cart-related customizing</a></li>
                                                            </ul>
</div>            <h1 id="src-72975274"> <span>Customizing the shopping cart calculation</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">
        $page.content
<p   
>The Kentico E-commerce Solution allows you to customize the shopping cart calculation engine. The system runs this calculation when working with the shopping cart during <a   href="Checkout_process.html">checkout</a> and when creating or editing <a   href="Orders.html">orders</a>. The calculation determines how the system applies <a   href="Discounts.html">discounts</a>, handles <a   href="Configuring_shipping_options.html">shipping costs</a>, adds <a   href="Configuring_taxes.html">taxes</a>, etc.</p>
<p   
>For example, you can:</p>
<ul class=" "><li class=" "><p   
>Completely replace the shopping cart calculation with a custom solution</p>
</li><li class=" "><p   
>Integrate custom steps into the calculation process</p>
</li></ul><p   
>To customize the shopping cart calculation:</p>
<ol class=" "><li class=" "><p   
>Open your Kentico project in Visual Studio.</p>
</li><li class=" "><p   
>Create new classes that implement the <a   href="#src-72975274_Customizingtheshoppingcartcalculation-Calculationinterfacesanddatatypes">calculation interfaces</a> (described below).</p>
    <div  class="confbox admonition admonition-tip">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Class location</strong><br/></p>
<p   
>For production sites, we recommend creating a new assembly (Class library project) in your Kentico solution and including the classes there. Then, add the appropriate references to both the assembly and the main Kentico web project. For more information, see <a   href="Best_practices_for_customization.html">Best practices for customization</a>.</p>
        </div>
    </div>
</li><li class=" "><p   
>Implement all methods required by the given interfaces.</p>
</li><li class=" "><p   
>Register your implementations of the interfaces using the <strong class=" ">RegisterImplementation</strong> assembly attribute (or use a <i class=" ">Factory</i> class to serve instances dynamically in certain cases).</p>
</li></ol><p   
>When you reload the website, the system uses the custom implementations when calculating the price totals and other data of shopping carts and orders.</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>In code, you can run the calculation for a shopping cart object (<i class=" ">ShoppingCartInfo</i>) by calling the object&#39;s <strong class=" ">Evaluate()</strong> method.</p>
        </div>
    </div>
    <div  class="confbox panel">
            <div class="title panel-header">On this page</div>
            <div class="panel-content">
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-72975274_Customizingtheshoppingcartcalculation-Calculationinterfacesanddatatypes">Calculation interfaces and data types</a></p>
</li><li class=" "><p   
><a   href="#src-72975274_Customizingtheshoppingcartcalculation-Defaultcalculationpipeline">Default calculation pipeline</a></p>
</li><li class=" "><p   
><a   href="#src-72975274_safe-id-Q3VzdG9taXppbmd0aGVzaG9wcGluZ2NhcnRjYWxjdWxhdGlvbi1FeGFtcGxl4oCTQWRkaW5nYW5leHRyYWNoYXJnZWNhbGN1bGF0aW9uc3RlcA">Example &ndash; Adding an extra charge calculation step</a></p>
</li></ul><p   
></p>
        </div>
    </div>
    <div  class="confbox panel">
            <div class="title panel-header">Related pages</div>
            <div class="panel-content">
<ul class=" "><li class=" "><p   
><a   href="E-commerce_customization_model.html">E-commerce customization model</a></p>
</li><li class=" "><p   
><a   href="Checkout_process.html">Checkout process</a></p>
</li><li class=" "><p   
><a   href="Orders.html">Orders</a></p>
</li></ul>        </div>
    </div>
    <h3 id="src-72975274_Customizingtheshoppingcartcalculation-Calculationinterfacesanddatatypes" class="heading "><span>Calculation interfaces and data types</span></h3>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>All mentioned classes can be found in the <strong class=" ">CMS.Ecommerce</strong> namespace.</p>
        </div>
    </div>
    <h4 id="src-72975274_Customizingtheshoppingcartcalculation-Maincalculationlogic" class="heading "><span>Main calculation logic</span></h4>
<p   
>The core shopping cart calculation is performed by the registered implementations of the following interfaces:</p>
<ul class=" "><li class=" "><p   
><strong class=" ">IShoppingCartCalculator</strong></p>
</li><li class=" "><p   
><strong class=" ">IShoppingCartCalculationFactory</strong> &ndash; serves an instance of a class implementing <i class=" ">IShoppingCartCalculator</i> for each site. Must be implemented to use custom <i class=" ">IShoppingCartCalculator</i> implementations.</p>
</li></ul><p   
>Implementations of <i class=" ">IShoppingCartCalculator</i> must contain the <strong class=" ">Calculate</strong> method. The method provides a <strong class=" ">CalculatorData</strong> parameter with the following properties:</p>
<ul class=" "><li class=" "><p   
><strong class=" ">Request</strong> &ndash; a <strong class=" ">CalculationRequest</strong> object that contains the data of the processed shopping cart, such as a collection of cart items (products), the customer object, the cart currency, etc.</p>
</li><li class=" "><p   
><strong class=" ">Result</strong> &ndash; a <strong class=" ">CalculationResult</strong> object that stores the results of the calculation, such as shopping cart totals, discount summaries, tax summaries, etc.</p>
</li></ul>    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Note</strong>: To ensure that your custom calculator implementations work without errors, you need to perform <i class=" ">null</i> checks before accessing <strong class=" ">CalculationRequest</strong> properties. The system runs the calculation process during early stages of the shopping cart life cycle where many properties are not set yet. For example, the <i class=" ">CalculationRequest.PaymentOption</i> property has a <i class=" ">null</i> value when calculating shopping carts where the customer has not selected a payment option yet.</p>
        </div>
    </div>
<p   
>To fully replace the shopping cart calculation logic, the <strong class=" ">Calculate</strong> method of your <i class=" ">IShoppingCartCalculator</i> implementation needs to process the data provided in <strong class=" ">CalculatorData.Request</strong> and set all available properties of <strong class=" ">CalculatorData.Result</strong>.</p>
<p   
>The default shopping cart calculation in Kentico uses a composite <i class=" ">IShoppingCartCalculator</i> step, consisting of multiple other <i class=" ">IShoppingCartCalculator</i> implementations that are executed in a specific order. See the <a   href="#src-72975274_Customizingtheshoppingcartcalculation-Defaultcalculationpipeline">Default calculation pipeline</a> section for details.</p>
    <h4 id="src-72975274_Customizingtheshoppingcartcalculation-Integrationwithshoppingcarts" class="heading "><span>Integration with shopping carts</span></h4>
<p   
>The E-commerce API uses the following interfaces to connect the main calculation logic to shopping cart objects:</p>
<ul class=" "><li class=" "><p   
><strong class=" ">IShoppingCartAdapterService</strong> &ndash; prepares the data for the <i class=" ">IShoppingCartCalculator</i> calculations and applies the results to the shopping cart. Implementations must contain the following methods:</p>
<ul class=" "><li class=" "><p   
><strong class=" ">GetCalculationRequest</strong>, <strong class=" ">GetCalculationResult</strong> &ndash; methods that initialize the <i class=" ">CalculationRequest</i> and <i class=" ">CalculationResult</i> objects for the calculation using the data of a specified shopping cart (<i class=" ">ShoppingCartInfo</i>).</p>
</li><li class=" "><p   
><strong class=" ">ApplyCalculationResult</strong> &ndash; applies the results (<i class=" ">CalculationResult</i>) to the specified shopping cart (<i class=" ">ShoppingCartInfo</i>) after the calculation.</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>You can create and register your own <strong class=" ">IShoppingCartAdapterService</strong> implementation if you need to add custom properties into the calculation data for use within <i class=" ">IShoppingCartCalculator</i> classes:</p>
<ol class=" "><li class=" "><p   
>Create custom classes that inherit from <strong class=" ">CalculationRequest</strong> or <strong class=" ">CalculationResult</strong>.</p>
</li><li class=" "><p   
>Add properties to the classes according to your requirements.</p>
</li><li class=" "><p   
>Define the <strong class=" ">GetCalculationRequest</strong> and <strong class=" ">GetCalculationResult</strong> methods within your <i class=" ">IShoppingCartAdapterService</i> implementation and return instances of your derived request or result classes.</p>
</li><li class=" "><p   
>If you need to use custom result properties to apply values to the shopping cart, convert the <i class=" ">CalculationResult</i> parameter to your derived type within the <strong class=" ">ApplyCalculationResult</strong> method.</p>
</li></ol>        </div>
    </div>
</li></ul></li><li class=" "><p   
><strong class=" ">IShoppingCartEvaluator</strong> &ndash; contains an <i class=" ">Evaluate</i> method that encapsulates the entire shopping cart evaluation and calculation logic. The default implementation prepares the calculation data using <i class=" ">IShoppingCartAdapterService</i>, runs the calculation using <i class=" ">IShoppingCartCalculationFactory</i>, and ensures automatic adding of free products to shopping carts for <a   href="Working_with_Buy_X_Get_Y_discounts.html">Buy X Get Y discounts</a>.</p>
</li></ul>    <h3 id="src-72975274_Customizingtheshoppingcartcalculation-Defaultcalculationpipeline" class="heading "><span>Default calculation pipeline</span></h3>
<p   
>The default shopping cart calculation in Kentico uses a composite implementation of the <i class=" ">IShoppingCartCalculator</i> interface &ndash; the <strong class=" ">ShoppingCartCalculatorCollection</strong> class. The <i class=" ">ShoppingCartCalculatorCollection</i> accepts an <i class=" ">IEnumerable</i> collection of other <i class=" ">IShoppingCartCalculator</i> instances (steps), calls the <strong class=" ">Calculate</strong> method of each step, and passes the <strong class=" ">CalculatorData</strong> between the steps.</p>
<p   
>The default calculation pipeline consists of the following steps (each step is an <i class=" ">IShoppingCartCalculator</i> implementation):</p>
    <div  class="tablewrap">
        <table class="wrapped confluenceTable">
                    <colgroup>
                                    <col />
                                    <col />
                                    <col />
                            </colgroup>
        <thead class=" ">    <tr>
            <td  class="numberingColumn confluenceTh" rowspan="1" colspan="1">
    <p   
><br/></p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Calculation step</p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Function</p>
            </td>
        </tr>
</thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>1</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>UnitPriceCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Calculates the unit price for all products in the shopping cart (including unit-level discounts &ndash; <a   href="Working_with_catalog_discounts.html">catalog discounts</a> and <a   href="Working_with_volume_discounts.html">volume discounts</a>).</p>
<p   
>Sets the following properties of each <i class=" ">CalculationResultItem</i> in the <i class=" ">CalculationResult.Items</i> collection:</p>
<ul class=" "><li class=" "><p   
><i class=" ">ItemUnitPrice</i></p>
</li><li class=" "><p   
><i class=" ">UnitDiscount</i></p>
</li><li class=" "><p   
><i class=" ">UnitDiscountSummary</i></p>
</li></ul>            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>2</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>CartItemDiscountCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Evaluates and calculates <a   href="Working_with_Buy_X_Get_Y_discounts.html">Buy X Get Y discounts</a> and <a   href="Working_with_product_coupons.html">Product coupons</a> for the shopping cart.</p>
<ul class=" "><li class=" "><p   
>Sets the <i class=" ">ItemDiscount</i> and <i class=" ">ItemDiscountSummary</i> properties for each <i class=" ">CalculationResultItem</i> in the <i class=" ">CalculationResult.Items</i> collection.</p>
</li><li class=" "><p   
>Adds any <a   href="Working_with_coupon_codes.html">coupon codes</a> related to the applied discounts into the <i class=" ">CalculationResult.AppliedCouponCodes</i> collection.</p>
</li></ul>            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>3</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>TotalValuesCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Calculates and sets the following total values:</p>
<ul class=" "><li class=" "><p   
><i class=" ">CalculationResult.Subtotal</i></p>
</li><li class=" "><p   
><i class=" "><i class=" ">CalculationResult.T</i>otal</i></p>
</li><li class=" "><p   
><i class=" ">CalculationResult.G</i><i class=" ">randTotal</i></p>
</li><li class=" "><p   
><i class=" ">CalculationResultItem.LineSubtotal</i> for each item in the <i class=" ">CalculationResult.Items</i> collection</p>
</li></ul><p   
>At this point, the <i class=" ">Subtotal</i>, <i class=" ">Total</i> and <i class=" ">GrandTotal</i> values are all the same &ndash; a sum of the <i class=" ">LineSubTotal</i> values for all items in <i class=" ">CalculationResult.Items</i>.</p>
            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>4</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>OrderDiscountsCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Evaluates and calculates <a   href="Working_with_order_discounts.html">order discounts</a> for the shopping cart.</p>
<ul class=" "><li class=" "><p   
>Sets the <i class=" ">CalculationResult.OrderDiscount</i> value.</p>
</li><li class=" "><p   
>Adds each applied order discount to the <i class=" ">CalculationResult.OrderDiscountSummary</i> collection.</p>
</li><li class=" "><p   
>If any of the applied order discounts use a <a   href="Working_with_coupon_codes.html">coupon code</a>, adds the coupon codes to the <i class=" ">CalculationResult.AppliedCouponCodes</i> collection.</p>
</li></ul>            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>5</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>TotalValuesCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Recalculates and sets the following total values:</p>
<ul class=" "><li class=" "><p   
><i class=" ">CalculationResult.Subtotal</i></p>
</li><li class=" "><p   
><i class=" "><i class=" ">CalculationResult.T</i>otal</i></p>
</li><li class=" "><p   
><i class=" ">CalculationResult.G</i><i class=" ">randTotal</i></p>
</li><li class=" "><p   
><i class=" ">CalculationResultItem.LineSubtotal</i> for each item in the <i class=" ">CalculationResult.Items</i> collection</p>
</li></ul><p   
>The <i class=" ">CalculationResult.OrderDiscount</i> value set by the previous step is now subtracted from the <i class=" ">Total</i> and <i class=" ">GrandTotal</i> values.</p>
            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>6</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>ShippingCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Calculates the shipping price for the shopping cart.</p>
<ul class=" "><li class=" "><p   
>Sets the <i class=" ">CalculationResult.Shipping</i> value.</p>
</li><li class=" "><p   
>If any <a   href="Working_with_free_shipping_offers.html">free shipping offers</a> with a <a   href="Working_with_coupon_codes.html">coupon code</a> are applied, adds the coupon codes to the <i class=" ">CalculationResult.AppliedCouponCodes</i> collection.</p>
</li></ul>            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>7</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>TaxCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Calculates taxes for all <i class=" ">CalculationRequest.Items</i> and the <i class=" ">CalculationResult.Shipping</i> value.</p>
<ul class=" "><li class=" "><p   
>Sets the overall <i class=" ">CalculationResult.Tax</i> value.</p>
</li><li class=" "><p   
>Fills the <i class=" ">CalculationResult.TaxSummary</i> collection based on the applied tax types.</p>
</li></ul>            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>8</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>TotalValuesCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Recalculates and sets the following total values:</p>
<ul class=" "><li class=" "><p   
><i class=" ">CalculationResult.Subtotal</i></p>
</li><li class=" "><p   
><i class=" "><i class=" ">CalculationResult.T</i>otal</i></p>
</li><li class=" "><p   
><i class=" ">CalculationResult.G</i><i class=" ">randTotal</i></p>
</li><li class=" "><p   
><i class=" ">CalculationResultItem.LineSubtotal</i> for each item in the <i class=" ">CalculationResult.Items</i> collection</p>
</li></ul><p   
>The <i class=" ">CalculationResult.Shipping</i> and <i class=" ">CalculationResult.Tax</i> values set by the previous steps are now added to the <i class=" ">Total</i> and <i class=" ">GrandTotal</i> values.</p>
            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>9</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>OtherPaymentsCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Calculates the values of <a   href="Working_with_gift_cards.html">gift cards</a> applied to the shopping cart.</p>
<ul class=" "><li class=" "><p   
>Sets the <i class=" ">CalculationResult.OtherPayments</i> value.</p>
</li><li class=" "><p   
>Adds each applied gift card to the <i class=" ">CalculationResult.OtherPaymentsApplication</i> summary collection.</p>
</li><li class=" "><p   
>Adds the <a   href="Working_with_coupon_codes.html">coupon code</a> of each applied gift card to the <i class=" ">CalculationResult.AppliedCouponCodes</i> collection.</p>
</li></ul>            </td>
        </tr>
    <tr>
            <td  class="numberingColumn confluenceTd" rowspan="1" colspan="1">
    <p   
>10</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>TotalValuesCalculator</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Recalculates and sets the following total values:</p>
<ul class=" "><li class=" "><p   
><i class=" ">CalculationResult.Subtotal</i></p>
</li><li class=" "><p   
><i class=" "><i class=" ">CalculationResult.T</i>otal</i></p>
</li><li class=" "><p   
><i class=" ">CalculationResult.G</i><i class=" ">randTotal</i></p>
</li><li class=" "><p   
><i class=" ">CalculationResultItem.LineSubtotal</i> for each item in the <i class=" ">CalculationResult.Items</i> collection</p>
</li></ul><p   
>The <i class=" ">CalculationResult.OtherPayments</i> value set by the previous step is now subtracted from the final <i class=" ">GrandTotal</i> value.</p>
            </td>
        </tr>
</tbody>        </table>
            </div>
    <h4 id="src-72975274_Customizingtheshoppingcartcalculation-Modifyingthedefaultcalculation" class="heading "><span>Modifying the default calculation</span></h4>
<p   
>You can use the <strong class=" ">ShoppingCartCalculatorCollection</strong> class to customize the shopping cart calculation while preserving the default calculation (or parts of it):</p>
<ol class=" "><li class=" "><p   
>Prepare an <i class=" ">IEnumerable</i> collection of <strong class=" ">IShoppingCartCalculator</strong> instances. Define your own calculation pipeline, consisting of the default calculation steps and your own custom <i class=" ">IShoppingCartCalculator</i> steps.</p>
</li><li class=" "><p   
>Create and register a custom <strong class=" ">IShoppingCartCalculationFactory</strong> implementation.</p>
</li><li class=" "><p   
>Implement the <strong class=" ">GetCalculator</strong> method in the <i class=" ">IShoppingCartCalculationFactory</i> class and return an instance of the default <strong class=" ">ShoppingCartCalculatorCollection</strong> class, with the prepared <i class=" ">IShoppingCartCalculator</i> collection as the constructor parameter.</p>
</li></ol>    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Note</strong>: If you have custom steps that modify the <strong class=" ">Subtotal</strong>, <strong class=" ">Total</strong> or <strong class=" ">GrandTotal</strong> values of the <strong class=" ">CalculationResult</strong>, you either need to run the steps after the last usage of the default <strong class=" ">TotalValuesCalculator</strong> step or you need to implement a custom calculator for the total values that reflects your customizations. Otherwise the <i class=" ">TotalValuesCalculator</i> step performs the default calculation of the shopping cart totals, which overwrites any values assigned by custom steps.</p>
        </div>
    </div>
    <h3 id="src-72975274_safe-id-Q3VzdG9taXppbmd0aGVzaG9wcGluZ2NhcnRjYWxjdWxhdGlvbi1FeGFtcGxl4oCTQWRkaW5nYW5leHRyYWNoYXJnZWNhbGN1bGF0aW9uc3RlcA" class="heading "><span>Example &ndash; Adding an extra charge calculation step</span></h3>
<p   
>The following example demonstrates how to add a custom step to the shopping cart calculation, while preserving all of the default calculation logic. The step adds an extra charge to the total price of the shopping cart or order based on the selected payment option.</p>
<p   
>Prepare a separate project for custom classes in your Kentico solution:</p>
<ol class=" "><li class=" "><p   
>Open your Kentico solution in Visual Studio.</p>
</li><li class=" "><p   
>Create a new <i class=" ">Class Library</i> project in the Kentico solution (or reuse an existing custom project).</p>
</li><li class=" "><p   
>Add references to the required Kentico libraries (DLLs) for the new project:<br/></p>
<ol class=" "><li class=" "><p   
>Right-click the project and select <strong class=" ">Add -&gt; Reference</strong>.</p>
</li><li class=" "><p   
>Select the <strong class=" ">Browse</strong> tab of the <strong class=" ">Reference manager</strong> dialog, click <strong class=" ">Browse</strong> and navigate to the <i class=" "><strong class=" ">Lib</strong> </i>folder of your Kentico web project.</p>
</li><li class=" "><p   
>Add references to the following libraries (and any others that you may need in your custom code):</p>
<ul class=" "><li class=" "><p   
><strong class=" ">CMS.Base.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Core.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.DataEngine.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Ecommerce.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Globalization.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Helpers.dll</strong></p>
</li><li class=" "><p   
><strong class=" ">CMS.Membership.dll</strong></p>
</li></ul></li></ol></li><li class=" "><p   
>Reference the custom project from the Kentico web project <i class=" ">(CMSApp</i> or <i class=" ">CMS)</i>.</p>
</li><li class=" "><p   
>Edit the custom project&#39;s <strong class=" ">AssemblyInfo.cs</strong> file (in the <i class=" ">Properties</i> folder).</p>
</li><li class=" "><p   
>Add the <strong class=" ">AssemblyDiscoverable</strong> assembly attribute:<br/></p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[assembly:AssemblyDiscoverable]</code></div>
</div>
    </div>
</li></ol><p   
></p>
<p   
>Continue by creating custom implementations of the <strong class=" ">IShoppingCartCalculationFactory</strong> and <strong class=" ">IShoppingCartCalculator</strong> interfaces:</p>
<ol class=" "><li class=" "><p   
>Add a new class under the custom project, implementing the <i class=" "><i class=" ">IShoppingCartCalculator</i></i> interface.</p>
</li><li class=" "><p   
>Implement the <strong class=" ">Calculate</strong> method to define the custom calculation logic that adds the extra charge to the shopping cart totals.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Core;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> ExtraChargeShoppingCartCalculator : IShoppingCartCalculator</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// Runs shopping cart calculation based on specified calculation data.</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/// &lt;/summary&gt;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> Calculate(CalculatorData calculationData)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        CalculationRequest request = calculationData.Request;</code></div>
<div class="line"><code class="plain">        CalculationResult result = calculationData.Result;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        </code><code class="keyword">decimal</code><code class="plain"> extraCharge = 0;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">		</code><code class="comments">// Adds an extra charge of 5 (in the site's main currency) to the shopping cart totals</code></div>
<div class="line"><code class="plain">		</code><code class="comments">// if the selected payment option's code name is 'custompayment'</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (calculationData.Request.PaymentOption?.PaymentOptionName.ToLowerInvariant() == </code><code class="string">"custompayment"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            extraCharge = 5m;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">            </code><code class="comments">// Uses the default Kentico currency API to convert the price</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// from the site's main currency into the requested currency (if necessary)</code></div>
<div class="line"><code class="plain">            ICurrencyConverterFactory currencyConverterFactory = Service.Resolve&lt;ICurrencyConverterFactory&gt;();</code></div>
<div class="line"><code class="plain">            ICurrencyConverter currencyConverter = currencyConverterFactory.GetCurrencyConverter(calculationData.Request.Site);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">            </code><code class="keyword">string</code><code class="plain"> siteMainCurrencyCode = Service.Resolve&lt;ISiteMainCurrencySource&gt;().GetSiteMainCurrencyCode(calculationData.Request.Site);</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">string</code><code class="plain"> currencyCode = calculationData.Request.Currency.CurrencyCode;</code></div>
<div class="line"><code class="plain">            </code></div>
<div class="line"><code class="plain">            extraCharge = currencyConverter.Convert(extraCharge, siteMainCurrencyCode, currencyCode);</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        result.Total += extraCharge;</code></div>
<div class="line"><code class="plain">        result.GrandTotal += extraCharge;</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p   
>Add a new class under the custom project, implementing the <i class=" ">IShoppingCartCalculationFactory </i>interface.</p>
</li><li class=" "><p   
>Prepare an <i class=" ">IEnumerable</i> collection of <i class=" ">IShoppingCartCalculator</i> instances matching the <a   href="#src-72975274_Customizingtheshoppingcartcalculation-Defaultcalculationpipeline">default calculation steps</a>, and add an instance of the custom <i class=" ">ExtraChargeShoppingCartCalculator</i> step to the end.</p>
</li><li class=" "><p   
>Implement the <strong class=" ">GetCalculator</strong> method in the <i class=" ">IShoppingCartCalculationFactory</i> class.</p>
<ul class=" "><li class=" "><p   
>Return an instance of the default <strong class=" ">ShoppingCartCalculatorCollection</strong> class, with the prepared <i class=" ">IShoppingCartCalculator</i> collection as the constructor parameter.</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">using</code><code class="plain"> System.Collections.Generic;</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.Ecommerce;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> CMS.DataEngine;</code></div>
<div class="line"> </div>
<div class="line"><code class="comments">// Registers the custom implementation of IShoppingCartCalculationFactory</code></div>
<div class="line"><code class="plain">[assembly: RegisterImplementation(</code><code class="keyword">typeof</code><code class="plain">(IShoppingCartCalculationFactory), </code><code class="keyword">typeof</code><code class="plain">(CustomShoppingCartCalculationFactory))]</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">class</code><code class="plain"> CustomShoppingCartCalculationFactory : IShoppingCartCalculationFactory</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Provides an instance of the customized shopping cart calculator</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> IShoppingCartCalculator GetCalculator(SiteInfoIdentifier siteIdentifier)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// This sample does not parameterize the calculator based on the current site</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Use the method's 'siteIdentifier' parameter if you need different calculation logic for each site</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">new</code><code class="plain"> ShoppingCartCalculatorCollection(CustomCalculationSteps);</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// Defines a custom pipeline of calculation steps</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">private</code><code class="plain"> </code><code class="keyword">static</code><code class="plain"> List&lt;IShoppingCartCalculator&gt; CustomCalculationSteps = </code></div>
<div class="line"><code class="plain">        </code><code class="keyword">new</code><code class="plain"> List&lt;IShoppingCartCalculator&gt;</code></div>
<div class="line"><code class="plain">        {</code></div>
<div class="line"><code class="plain">            </code><code class="comments">// The default calculation pipeline</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> UnitPriceCalculator(),</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> CartItemDiscountCalculator(),</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> TotalValuesCalculator(),</code></div>
<div class="line"><code class="plain">			</code><code class="keyword">new</code><code class="plain"> OrderDiscountsCalculator(),</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> TotalValuesCalculator(),</code></div>
<div class="line"><code class="plain">			</code><code class="keyword">new</code><code class="plain"> ShippingCalculator(),</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> TaxCalculator(),</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> TotalValuesCalculator(),</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> OtherPaymentsCalculator(),</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> TotalValuesCalculator(),</code></div>
<div class="line"><code class="plain">            </code></div>
<div class="line"><code class="plain">            </code><code class="comments">// Adds the custom "extra charge" step to the end of the calculation</code></div>
<div class="line"><code class="plain">            </code><code class="keyword">new</code><code class="plain"> ExtraChargeShoppingCartCalculator()</code></div>
<div class="line"><code class="plain">        };</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
</li><li class=" "><p   
>Save all changes and <strong class=" ">Build</strong> the custom project.</p>
</li></ol><p   
>The registered <strong class=" ">CustomShoppingCartCalculationFactory</strong> class provides an instance of <strong class=" ">ShoppingCartCalculatorCollection</strong> with an extended list of calculation steps. The calculation performs all of the default steps without any changes, and the custom <strong class=" ">ExtraChargeShoppingCartCalculator</strong> step at the end of the calculation pipeline adds an extra charge to orders that use the <i class=" ">&quot;Custom payment&quot;</i> payment option.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
><strong class=" ">Note</strong>: This basic example does not display any information about the reason for the price increase to customers or store administrators (for example in the shopping cart details during checkout, when editing orders, or in <a   href="Configuring_invoices.html">invoices</a>). The total values of shopping carts or orders may appear inconsistent unless you add content explaining the price change (for example, you can mention the extra charge in the display name of the related payment option).</p>
        </div>
    </div>
        </div>

    </article>


               
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
